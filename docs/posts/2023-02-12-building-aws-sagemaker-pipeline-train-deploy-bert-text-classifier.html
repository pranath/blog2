<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pranath Fernando">
<meta name="dcterms.date" content="2023-02-12">
<meta name="description" content="In this project we train and deploy a BERT Based text classifier using AWS Sagemaker pipelines, and describe how this can help with MLOPS to provide the most efficient path to production for training deploying and maintaining machine learning models at scale in production.">

<title>LivingDataLab - Building an AWS SageMaker Pipeline for a BERT Based text classifier</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-91568149-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="LivingDataLab - Building an AWS SageMaker Pipeline for a BERT Based text classifier">
<meta property="og:description" content="In this project we train and deploy a BERT Based text classifier using AWS Sagemaker pipelines, and describe how this can help with MLOPS to provide the most efficient path to production for…">
<meta property="og:image" content="https://github.com/pranath/blog/raw/master/images/aws3.png">
<meta property="og:site-name" content="LivingDataLab">
<meta name="twitter:title" content="LivingDataLab - Building an AWS SageMaker Pipeline for a BERT Based text classifier">
<meta name="twitter:description" content="In this project we train and deploy a BERT Based text classifier using AWS Sagemaker pipelines, and describe how this can help with MLOPS to provide the most efficient path to production for…">
<meta name="twitter:image" content="https://github.com/pranath/blog/raw/master/images/aws3.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">LivingDataLab</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pranath"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/LivingDataLab"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Building an AWS SageMaker Pipeline for a BERT Based text classifier</h1>
                  <div>
        <div class="description">
          In this project we train and deploy a BERT Based text classifier using AWS Sagemaker pipelines, and describe how this can help with MLOPS to provide the most efficient path to production for training deploying and maintaining machine learning models at scale in production.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">aws</div>
                <div class="quarto-category">cloud-data-science</div>
                <div class="quarto-category">natural-language-processing</div>
                <div class="quarto-category">deep-learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Pranath Fernando </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 12, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<!-- Begin Mailchimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/classic-071822.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    /* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
    <form action="https://livingdatalab.us8.list-manage.com/subscribe/post?u=e2d57b0d6e43b4f6bff927a55&amp;id=a30bdff125&amp;f_id=009d05e0f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
        <div id="mc_embed_signup_scroll">
        <h2>Subscribe</h2>
<div class="mc-field-group">
    <label for="mce-EMAIL">Email Address
</label>
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required="">
    <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
    <div id="mce-responses" class="clear foot">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_e2d57b0d6e43b4f6bff927a55_a30bdff125" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
            </div>
        </div>
    </div>
</form>
</div>
<script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<!--End mc_embed_signup-->

</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">1</span>  Introduction</a></li>
  <li><a href="#what-are-mlops" id="toc-what-are-mlops" class="nav-link" data-scroll-target="#what-are-mlops"><span class="toc-section-number">2</span>  What are MLOPS ?</a></li>
  <li><a href="#aws-pipelines-terminology" id="toc-aws-pipelines-terminology" class="nav-link" data-scroll-target="#aws-pipelines-terminology"><span class="toc-section-number">3</span>  AWS Pipelines Terminology</a></li>
  <li><a href="#creating-a-bert-pipeline" id="toc-creating-a-bert-pipeline" class="nav-link" data-scroll-target="#creating-a-bert-pipeline"><span class="toc-section-number">4</span>  Creating a BERT Pipeline</a></li>
  <li><a href="#configure-the-dataset-and-processing-step" id="toc-configure-the-dataset-and-processing-step" class="nav-link" data-scroll-target="#configure-the-dataset-and-processing-step"><span class="toc-section-number">5</span>  Configure the dataset and processing step</a>
  <ul class="collapse">
  <li><a href="#configure-s3-path-for-raw-input-data" id="toc-configure-s3-path-for-raw-input-data" class="nav-link" data-scroll-target="#configure-s3-path-for-raw-input-data"><span class="toc-section-number">5.1</span>  Configure S3 path for raw input data</a></li>
  <li><a href="#configure-processing-step" id="toc-configure-processing-step" class="nav-link" data-scroll-target="#configure-processing-step"><span class="toc-section-number">5.2</span>  Configure processing step</a></li>
  </ul></li>
  <li><a href="#configure-training-step" id="toc-configure-training-step" class="nav-link" data-scroll-target="#configure-training-step"><span class="toc-section-number">6</span>  Configure training step</a>
  <ul class="collapse">
  <li><a href="#define-parameters" id="toc-define-parameters" class="nav-link" data-scroll-target="#define-parameters"><span class="toc-section-number">6.1</span>  Define parameters</a></li>
  <li><a href="#configure-hyper-parameters" id="toc-configure-hyper-parameters" class="nav-link" data-scroll-target="#configure-hyper-parameters"><span class="toc-section-number">6.2</span>  Configure hyper-parameters</a></li>
  <li><a href="#configure-model-evaluation-metrics" id="toc-configure-model-evaluation-metrics" class="nav-link" data-scroll-target="#configure-model-evaluation-metrics"><span class="toc-section-number">6.3</span>  Configure model-evaluation metrics</a></li>
  <li><a href="#configure-the-pytorchestimator" id="toc-configure-the-pytorchestimator" class="nav-link" data-scroll-target="#configure-the-pytorchestimator"><span class="toc-section-number">6.4</span>  Configure the <code>PyTorchEstimator</code></a></li>
  <li><a href="#setup-pipeline-step-caching" id="toc-setup-pipeline-step-caching" class="nav-link" data-scroll-target="#setup-pipeline-step-caching"><span class="toc-section-number">6.5</span>  Setup pipeline step caching</a></li>
  <li><a href="#configure-the-trainingstep" id="toc-configure-the-trainingstep" class="nav-link" data-scroll-target="#configure-the-trainingstep"><span class="toc-section-number">6.6</span>  Configure the <code>TrainingStep</code></a></li>
  </ul></li>
  <li><a href="#configure-model-evaluation-step" id="toc-configure-model-evaluation-step" class="nav-link" data-scroll-target="#configure-model-evaluation-step"><span class="toc-section-number">7</span>  Configure model-evaluation step</a></li>
  <li><a href="#configure-and-register-model-step" id="toc-configure-and-register-model-step" class="nav-link" data-scroll-target="#configure-and-register-model-step"><span class="toc-section-number">8</span>  Configure and register model step</a>
  <ul class="collapse">
  <li><a href="#configure-the-model-for-deployment" id="toc-configure-the-model-for-deployment" class="nav-link" data-scroll-target="#configure-the-model-for-deployment"><span class="toc-section-number">8.1</span>  Configure the model for deployment</a></li>
  <li><a href="#register-the-model-for-deployment" id="toc-register-the-model-for-deployment" class="nav-link" data-scroll-target="#register-the-model-for-deployment"><span class="toc-section-number">8.2</span>  Register the model for deployment</a></li>
  </ul></li>
  <li><a href="#create-model-for-deployment-step" id="toc-create-model-for-deployment-step" class="nav-link" data-scroll-target="#create-model-for-deployment-step"><span class="toc-section-number">9</span>  Create model for deployment step</a></li>
  <li><a href="#check-accuracy-condition-step" id="toc-check-accuracy-condition-step" class="nav-link" data-scroll-target="#check-accuracy-condition-step"><span class="toc-section-number">10</span>  Check accuracy condition step</a></li>
  <li><a href="#create-pipeline" id="toc-create-pipeline" class="nav-link" data-scroll-target="#create-pipeline"><span class="toc-section-number">11</span>  Create pipeline</a>
  <ul class="collapse">
  <li><a href="#define-a-pipeline-of-parameters-steps-and-conditions" id="toc-define-a-pipeline-of-parameters-steps-and-conditions" class="nav-link" data-scroll-target="#define-a-pipeline-of-parameters-steps-and-conditions"><span class="toc-section-number">11.1</span>  Define a pipeline of parameters, steps, and conditions</a></li>
  <li><a href="#start-pipeline" id="toc-start-pipeline" class="nav-link" data-scroll-target="#start-pipeline"><span class="toc-section-number">11.2</span>  Start Pipeline</a></li>
  <li><a href="#wait-for-pipeline-execution" id="toc-wait-for-pipeline-execution" class="nav-link" data-scroll-target="#wait-for-pipeline-execution"><span class="toc-section-number">11.3</span>  Wait for pipeline execution</a></li>
  <li><a href="#describe-completed-pipeline" id="toc-describe-completed-pipeline" class="nav-link" data-scroll-target="#describe-completed-pipeline"><span class="toc-section-number">11.4</span>  Describe completed pipeline</a></li>
  <li><a href="#wait-for-the-pipeline-to-complete" id="toc-wait-for-the-pipeline-to-complete" class="nav-link" data-scroll-target="#wait-for-the-pipeline-to-complete"><span class="toc-section-number">11.5</span>  Wait for the pipeline to complete</a></li>
  </ul></li>
  <li><a href="#evaluate-the-model" id="toc-evaluate-the-model" class="nav-link" data-scroll-target="#evaluate-the-model"><span class="toc-section-number">12</span>  Evaluate the model</a>
  <ul class="collapse">
  <li><a href="#describe-evaluation-metrics" id="toc-describe-evaluation-metrics" class="nav-link" data-scroll-target="#describe-evaluation-metrics"><span class="toc-section-number">12.1</span>  Describe evaluation metrics</a></li>
  <li><a href="#review-the-evaluation-report" id="toc-review-the-evaluation-report" class="nav-link" data-scroll-target="#review-the-evaluation-report"><span class="toc-section-number">12.2</span>  Review the evaluation report</a></li>
  <li><a href="#list-pipeline-artifacts" id="toc-list-pipeline-artifacts" class="nav-link" data-scroll-target="#list-pipeline-artifacts"><span class="toc-section-number">12.3</span>  List pipeline artifacts</a></li>
  </ul></li>
  <li><a href="#deploy-and-test-the-model" id="toc-deploy-and-test-the-model" class="nav-link" data-scroll-target="#deploy-and-test-the-model"><span class="toc-section-number">13</span>  Deploy and test the model</a>
  <ul class="collapse">
  <li><a href="#approve-trained-model" id="toc-approve-trained-model" class="nav-link" data-scroll-target="#approve-trained-model"><span class="toc-section-number">13.1</span>  Approve trained model</a></li>
  <li><a href="#deploy-model" id="toc-deploy-model" class="nav-link" data-scroll-target="#deploy-model"><span class="toc-section-number">13.2</span>  Deploy model</a></li>
  <li><a href="#create-endpoint-from-registry" id="toc-create-endpoint-from-registry" class="nav-link" data-scroll-target="#create-endpoint-from-registry"><span class="toc-section-number">13.3</span>  Create endpoint from registry</a></li>
  <li><a href="#test-model" id="toc-test-model" class="nav-link" data-scroll-target="#test-model"><span class="toc-section-number">13.4</span>  Test model</a></li>
  <li><a href="#sagemaker-studio-extensions" id="toc-sagemaker-studio-extensions" class="nav-link" data-scroll-target="#sagemaker-studio-extensions"><span class="toc-section-number">13.5</span>  SageMaker Studio extensions</a></li>
  </ul></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements"><span class="toc-section-number">14</span>  Acknowledgements</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In <a href="../#category=aws">earlier articles we introduced AWS cloud services for data science</a>, and showed how it can help with different stages of the data science &amp; machine learning workflow.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_ds_workflow.png" title="The AWS Data Science Workflow" class="img-fluid"></p>
<p>In this project will look at the deploy and manage phase for the workflow using <strong>AWS Sagemaker Pipelines</strong>, which will actually involve all previous phases.</p>
<p>In particular we will do the following:</p>
<ul>
<li>Define and run a pipeline using a directed acyclic graph (DAG) with specific pipeline parameters and model hyper-parameters</li>
<li>Define a processing step that cleans, balances, transforms, and splits our dataset into train, validation, and test dataset</li>
<li>Define a training step that trains a model using the train and validation datasets</li>
<li>Define a processing step that evaluates the trained model’s performance on the test dataset</li>
<li>Define a register model step that creates a model package from the trained model</li>
<li>Define a conditional step that checks the model’s performance and conditionally registers the model for deployment</li>
</ul>
<p>Using the raw <a href="https://www.kaggle.com/nicapotato/womens-ecommerce-clothing-reviews">Women’s Clothing Reviews</a> dataset - we will prepare it to train a deep learning BERT-based natural language processing (NLP) model. The model will be used to classify customer reviews into positive (1), neutral (0) and negative (-1) sentiment.</p>
</section>
<section id="what-are-mlops" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="what-are-mlops"><span class="header-section-number">2</span> What are MLOPS ?</h2>
<p>MLOPS stands for Machine Learning Operations - but what does that mean?</p>
<p>MLOps builds on DevOps practices that encompass people, process, and technology. However, MLOps also includes considerations and practices that are really unique to machine learning workloads. All of these practices aim to be able to deliver machine learning workloads quickly to production while still maintaining high quality consistency and ensuring end-to-end traceability.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_path_mlmodels.png" title="Consideratons" class="img-fluid"></p>
<p>It’s important to consider that the machine learning development life cycle is very different than the software development life cycle for a variety of reasons.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_path_mlmodels2.png" title="Challenges" class="img-fluid"></p>
<p>First, the model development life cycle is difficult to plan for from a project management perspective. It typically includes longer experimentation cycles than you would see in a standard agile software development process. Also the development of machine learning models includes data tasks like feature engineering and data preparation. You also have data processing code, as well as new inputs and artifacts to consider for versioning. You also have additional pipeline task as well. When you start to look at automating the machine learning workflow, the inputs and artifacts that are generated across these tasks result in multiple disparate pipelines with dependencies that can be a bit more challenging, stitched together than a typical software development workflow.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_opml.png" title="Goals" class="img-fluid"></p>
<p>Second, some models exist by themselves where you might be manually reading prediction requests and getting responses through a batch process or even within your notebook on an ad hoc basis. This is especially true in research environments. However, in many cases, a model is typically a small part of an overall solution that incorporates machine-learning. While that model is still a very key component to that solution, most often there is a need for other components that need to be built or integrated. As an example, consider your product review use case and your model that is predicting the classes of sentiment for a product review. That model itself will be able to classify the sentiment related to a product, but you also need to consider how that prediction will actually be used and potentially integrated into other existing applications. For this, there may be additional tasks like creating a rest API as a common interface for other applications to integrate with your model or even building applications that can respond to those reviews. This could mean creating automation to initiate back-end processes that allow for customer support engineers to quickly react and respond to any negative reviews.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_opml2.png" title="Path to production" class="img-fluid"></p>
<p>A third consideration is that where typically multiple personas span the machine learning development lifecycle, and all are really needed to ultimately be able to build, deploy, integrate, and operate a machine learning workload. This can create challenges as these personas often have competing priorities and needs. There may also be skill gaps in building an operating machine learning workloads. As an example, a data scientist may not have a traditional IT background. While they may be very comfortable in creating a model that meets the performance objectives that have been identified for your particular machine learning use case, they may not know how to host that model in a way that it can be consumed by other applications or other systems. In this case, there may be a need to have a deployment engineer that is also engaged to help in building out the infrastructure and the resources that are needed to operate and host that model.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_opml3.png" title="Accelerating the path to production" class="img-fluid"></p>
<p>Also, you might need to integrate that hosted model with another application. In this case, you’re likely to depend on a software engineer to perform that integration. If there isn’t a cross-functional team with the same project goals in place, competing priorities and skill gaps across these personas make it really difficult to provide that path to production for your model.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_opml4.png" title="Improving the Quality of Deployed Models" class="img-fluid"></p>
<p>Finally, many teams have processes in place supporting different regulatory or even internal corporate requirements. This means that when you’re creating your machine learning pipeline, sometimes you also need to be able to ensure that traditional practices can be included inside the steps of your pipeline. Something like change management as an example here. This may mean that within your pipeline, you’re going to automatically open a change ticket anytime a new model gets deployed to production. Or maybe it’s a manual approval that’s required before your model can deploy to production. All of these processes may need to be incorporated inside your machine learning pipeline.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/aws_opml5.png" title="Key Considerations" class="img-fluid"></p>
<p><strong>MLOps aims to provide the most efficient path to production by reducing manual hand-offs between the steps in your workflow, increasing automation within those steps in your workflow, and then going a step further to orchestrate the steps across your workflow.</strong></p>
</section>
<section id="aws-pipelines-terminology" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="aws-pipelines-terminology"><span class="header-section-number">3</span> AWS Pipelines Terminology</h2>
<p>This project focuses on the following features of Amazon SageMaker Pipelines:</p>
<ul>
<li><strong>Pipelines</strong> - a directed acyclic graph (DAG) of steps and conditions to orchestrate SageMaker jobs and resource creation</li>
<li><strong>Processing job steps</strong> - a simplified, managed experience on SageMaker to run data processing workloads, such as feature engineering, data validation, model evaluation, and model explainability</li>
<li><strong>Training job steps</strong> - an iterative process that teaches a model to make predictions on new data by presenting examples from a training dataset</li>
<li><strong>Conditional step execution</strong> - provides conditional execution of branches in a pipeline</li>
<li><strong>Registering models</strong> - register a model in a model registry to create a deployable models in Amazon SageMaker</li>
<li><strong>Parameterized pipeline executions</strong> - allows pipeline executions to vary by supplied parameters</li>
<li><strong>Model endpoint</strong> - hosts the model as a REST endpoint to serve predictions from new data</li>
</ul>
</section>
<section id="creating-a-bert-pipeline" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="creating-a-bert-pipeline"><span class="header-section-number">4</span> Creating a BERT Pipeline</h2>
<p>The pipeline that we will create follows a typical machine learning application pattern of pre-processing, training, evaluation, and model registration.</p>
<p>In the processing step, we will perform feature engineering to transform the <code>review_body</code> text into BERT embeddings using the pre-trained BERT model and split the dataset into train, validation and test files. The transformed dataset is stored in a feature store. To optimize for Tensorflow training, the transformed dataset files are saved using the TFRecord format in Amazon S3.</p>
<p>In the training step, we will fine-tune the BERT model to the customer reviews dataset and add a new classification layer to predict the <code>sentiment</code> for a given <code>review_body</code>.</p>
<p>In the evaluation step, we will take the trained model and a test dataset as input, and produce a JSON file containing classification evaluation metrics.</p>
<p>In the condition step, we will register the trained model if the accuracy of the model, as determined by our evaluation step, exceeds a given threshold value.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/bert_sagemaker_pipeline.png" title="BERT Sagemaker Pipelines" class="img-fluid"></p>
<p>First, let’s install the required modules.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> botocore</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> botocore.exceptions <span class="im">import</span> ClientError</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> botocore.config.Config(user_agent_extra<span class="op">=</span><span class="st">'dlai-pds/c2/w3'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># low-level service client of the boto3 session</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>sm <span class="op">=</span> boto3.client(service_name<span class="op">=</span><span class="st">'sagemaker'</span>, </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                  config<span class="op">=</span>config)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sm_runtime <span class="op">=</span> boto3.client(<span class="st">'sagemaker-runtime'</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                          config<span class="op">=</span>config)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>sess <span class="op">=</span> sagemaker.Session(sagemaker_client<span class="op">=</span>sm,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                         sagemaker_runtime_client<span class="op">=</span>sm_runtime)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> sess.default_bucket()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>role <span class="op">=</span> sagemaker.get_execution_role()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>region <span class="op">=</span> sess.boto_region_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s setup the pipeline name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>timestamp <span class="op">=</span> <span class="bu">int</span>(time.time())</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>pipeline_name <span class="op">=</span> <span class="st">'BERT-pipeline-</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(timestamp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-the-dataset-and-processing-step" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="configure-the-dataset-and-processing-step"><span class="header-section-number">5</span> Configure the dataset and processing step</h2>
<section id="configure-s3-path-for-raw-input-data" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="configure-s3-path-for-raw-input-data"><span class="header-section-number">5.1</span> Configure S3 path for raw input data</h3>
<p>The raw dataset is in the public S3 bucket. Let’s start by specifying the S3 location of it:</p>
<div class="cell" data-outputid="bf6a9f74-3ac8-41f3-9687-cd1b46820068">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>raw_input_data_s3_uri <span class="op">=</span> <span class="st">'s3://dlai-practical-data-science/data/raw/'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(raw_input_data_s3_uri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>s3://dlai-practical-data-science/data/raw/</code></pre>
</div>
</div>
<p>List the files in the S3 bucket (in this case it will be just one file):</p>
<div class="cell" data-outputid="704edfd2-2e74-445d-fd0a-d261ce456342">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>aws s3 ls $raw_input_data_s3_uri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2021-04-30 02:21:06    8457214 womens_clothing_ecommerce_reviews.csv</code></pre>
</div>
</div>
</section>
<section id="configure-processing-step" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="configure-processing-step"><span class="header-section-number">5.2</span> Configure processing step</h3>
<p>For the pipeline workflow we will need to create workflow parameters of a specific type: integer, string, or float.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.parameters <span class="im">import</span> (</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    ParameterInteger,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    ParameterString,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    ParameterFloat,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now set the parameters for the processing step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>processing_instance_type <span class="op">=</span> ParameterString(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ProcessingInstanceType"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"ml.c5.2xlarge"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>processing_instance_count <span class="op">=</span> ParameterInteger(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ProcessingInstanceCount"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>train_split_percentage <span class="op">=</span> ParameterFloat(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainSplitPercentage"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="fl">0.90</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>validation_split_percentage <span class="op">=</span> ParameterFloat(</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ValidationSplitPercentage"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>test_split_percentage <span class="op">=</span> ParameterFloat(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TestSplitPercentage"</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>balance_dataset <span class="op">=</span> ParameterString(</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"BalanceDataset"</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"True"</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>max_seq_length <span class="op">=</span> ParameterInteger(</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"MaxSeqLength"</span>,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>feature_store_offline_prefix <span class="op">=</span> ParameterString(</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"FeatureStoreOfflinePrefix"</span>,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"reviews-feature-store-"</span> <span class="op">+</span> <span class="bu">str</span>(timestamp),</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>feature_group_name <span class="op">=</span> ParameterString(</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"FeatureGroupName"</span>,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"reviews-feature-group-"</span> <span class="op">+</span> <span class="bu">str</span>(timestamp)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>input_data <span class="op">=</span> ParameterString(</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"InputData"</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span>raw_input_data_s3_uri,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting up scikit-learn-based processor, pass the SageMaker execution role, processing instance type and instance count.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.processing <span class="im">import</span> SKLearnProcessor</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> SKLearnProcessor(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">'0.23-1'</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>processing_instance_type,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span>processing_instance_count,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    env<span class="op">=</span>{<span class="st">'AWS_DEFAULT_REGION'</span>: region},                             </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will use the processor instance to construct a <code>ProcessingStep</code>, along with the input and output channels and the code that will be executed when the pipeline invokes pipeline execution. This is very similar to a processor instance’s <code>run</code> method, for those familiar with the existing Python SDK.</p>
<p>Note the <code>"sentiment-train"</code>, <code>"sentiment-validation"</code> and <code>"sentiment-test"</code> named channels specified in the output configuration for the processing job. Such step <code>Properties</code> can be used in subsequent steps and will resolve to their runtime values at execution. In particular, we will call out this usage defining the training step.</p>
<div class="cell" data-outputid="cccebd03-d359-47d4-cb04-6cb53cde120a">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.processing <span class="im">import</span> ProcessingInput, ProcessingOutput</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> ProcessingStep</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>processing_inputs<span class="op">=</span>[</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    ProcessingInput(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        input_name<span class="op">=</span><span class="st">'raw-input-data'</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        source<span class="op">=</span>input_data,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        destination<span class="op">=</span><span class="st">'/opt/ml/processing/input/data/'</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        s3_data_distribution_type<span class="op">=</span><span class="st">'ShardedByS3Key'</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>processing_outputs<span class="op">=</span>[</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    ProcessingOutput(output_name<span class="op">=</span><span class="st">'sentiment-train'</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                     source<span class="op">=</span><span class="st">'/opt/ml/processing/output/sentiment/train'</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                     s3_upload_mode<span class="op">=</span><span class="st">'EndOfJob'</span>),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    ProcessingOutput(output_name<span class="op">=</span><span class="st">'sentiment-validation'</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                     source<span class="op">=</span><span class="st">'/opt/ml/processing/output/sentiment/validation'</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                     s3_upload_mode<span class="op">=</span><span class="st">'EndOfJob'</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    ProcessingOutput(output_name<span class="op">=</span><span class="st">'sentiment-test'</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                     source<span class="op">=</span><span class="st">'/opt/ml/processing/output/sentiment/test'</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                     s3_upload_mode<span class="op">=</span><span class="st">'EndOfJob'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>]        </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>processing_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Processing'</span>, </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="st">'src/prepare_data.py'</span>,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    processor<span class="op">=</span>processor,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>processing_inputs,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>processing_outputs,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    job_arguments<span class="op">=</span>[<span class="st">'--train-split-percentage'</span>, <span class="bu">str</span>(train_split_percentage.default_value),                   </span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--validation-split-percentage'</span>, <span class="bu">str</span>(validation_split_percentage.default_value),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--test-split-percentage'</span>, <span class="bu">str</span>(test_split_percentage.default_value),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--balance-dataset'</span>, <span class="bu">str</span>(balance_dataset.default_value),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--max-seq-length'</span>, <span class="bu">str</span>(max_seq_length.default_value),                   </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--feature-store-offline-prefix'</span>, <span class="bu">str</span>(feature_store_offline_prefix.default_value),</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'--feature-group-name'</span>, <span class="bu">str</span>(feature_group_name.default_value)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                  ]</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>)        </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(processing_step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ProcessingStep(name='Processing', step_type=&lt;StepTypeEnum.PROCESSING: 'Processing'&gt;)</code></pre>
</div>
</div>
<p>Now we can call out the properties of the processing job as an object using the command <code>processing_step.properties</code>. To print out and explore the attributes use <code>__dict__</code> method.</p>
<div class="cell" data-outputid="24eec809-fdf8-45c0-dc04-721ac29153c2">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print out the list of the processing job properties</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    processing_step.properties.__dict__,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>, default<span class="op">=</span><span class="bu">str</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "AppSpecification": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298a10&gt;",
    "AutoMLJobArn": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431d10&gt;",
    "CreationTime": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431950&gt;",
    "Environment": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298690&gt;",
    "ExitMessage": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431d50&gt;",
    "ExperimentConfig": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf52a0b10&gt;",
    "FailureReason": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431750&gt;",
    "LastModifiedTime": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431a10&gt;",
    "MonitoringScheduleArn": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431190&gt;",
    "NetworkConfig": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298b90&gt;",
    "ProcessingEndTime": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431610&gt;",
    "ProcessingInputs": "&lt;sagemaker.workflow.properties.PropertiesList object at 0x7fcdf5298350&gt;",
    "ProcessingJobArn": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431410&gt;",
    "ProcessingJobName": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298590&gt;",
    "ProcessingJobStatus": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431310&gt;",
    "ProcessingOutputConfig": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298510&gt;",
    "ProcessingResources": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf52984d0&gt;",
    "ProcessingStartTime": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431ed0&gt;",
    "RoleArn": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298650&gt;",
    "StoppingCondition": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5298a50&gt;",
    "TrainingJobArn": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5431bd0&gt;",
    "_path": "Steps.Processing",
    "_shape_name": "DescribeProcessingJobResponse"
}</code></pre>
</div>
</div>
<p>Pull the channel <code>sentiment-train</code> from the output configuration of the processing job. Print out the attributes of the resulting object:</p>
<div class="cell" data-outputid="1a5369ca-8996-42cc-a2d7-6db70c5aede9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    processing_step.properties.ProcessingOutputConfig.Outputs[<span class="st">'sentiment-train'</span>].__dict__, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>, default<span class="op">=</span><span class="bu">str</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "AppManaged": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf543c490&gt;",
    "FeatureStoreOutput": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf54d4510&gt;",
    "OutputName": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf5384650&gt;",
    "S3Output": "&lt;sagemaker.workflow.properties.Properties object at 0x7fcdf53845d0&gt;",
    "_path": "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-train']",
    "_shape_name": "ProcessingOutput"
}</code></pre>
</div>
</div>
<p>Now we can pull and print out attributes of the S3 output path related to the <code>sentiment-train</code> output channel:</p>
<div class="cell" data-outputid="dfa191f0-ccff-4e84-c304-4a64f757b7f7">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    processing_step.properties.ProcessingOutputConfig.Outputs[<span class="st">'sentiment-train'</span>].S3Output.S3Uri.__dict__,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>, default<span class="op">=</span><span class="bu">str</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "__str__": "S3Uri",
    "_path": "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-train'].S3Output.S3Uri",
    "_shape_name": "S3Uri"
}</code></pre>
</div>
</div>
<p>Let’s pull and print out attributes of the S3 output path object related to the <code>sentiment-test</code> output channel.</p>
<div class="cell" data-outputid="da8c78c7-73fc-49b9-ae1b-de5351dd2c23">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    processing_step.properties.ProcessingOutputConfig.Outputs[<span class="st">'sentiment-test'</span>].S3Output.S3Uri.__dict__, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    indent<span class="op">=</span><span class="dv">4</span>, sort_keys<span class="op">=</span><span class="va">True</span>, default<span class="op">=</span><span class="bu">str</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    "__str__": "S3Uri",
    "_path": "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-test'].S3Output.S3Uri",
    "_shape_name": "S3Uri"
}</code></pre>
</div>
</div>
<p>These objects can be passed into the next steps of the workflow. Also, we can pull the arguments of the processing step with the corresponding function. The result is in the dictionary format.</p>
<div class="cell" data-outputid="1cad757e-7257-4de9-9839-87e1064dbb23">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>processing_step.arguments.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>dict_keys(['ProcessingResources', 'AppSpecification', 'RoleArn', 'ProcessingInputs', 'ProcessingOutputConfig', 'Environment'])</code></pre>
</div>
</div>
<p>Let’s pull and review processing inputs from the arguments of the processing step:</p>
<div class="cell" data-outputid="d923a819-de37-4576-ce4a-f121a31e5b25">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>processing_step.arguments[<span class="st">'ProcessingInputs'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>[{'InputName': 'raw-input-data',
  'AppManaged': False,
  'S3Input': {'S3Uri': ParameterString(name='InputData', parameter_type=&lt;ParameterTypeEnum.STRING: 'String'&gt;, default_value='s3://dlai-practical-data-science/data/raw/'),
   'LocalPath': '/opt/ml/processing/input/data/',
   'S3DataType': 'S3Prefix',
   'S3InputMode': 'File',
   'S3DataDistributionType': 'ShardedByS3Key',
   'S3CompressionType': 'None'}},
 {'InputName': 'code',
  'AppManaged': False,
  'S3Input': {'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-22-918/input/code/prepare_data.py',
   'LocalPath': '/opt/ml/processing/input/code',
   'S3DataType': 'S3Prefix',
   'S3InputMode': 'File',
   'S3DataDistributionType': 'FullyReplicated',
   'S3CompressionType': 'None'}}]</code></pre>
</div>
</div>
<p>Let’s now pull and review configuration of the processing outputs from the arguments of the processing step.</p>
<div class="cell" data-outputid="b1a5bc56-0416-441d-a771-8e40ca39c1ec">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>processing_step.arguments[<span class="st">'ProcessingOutputConfig'</span>] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>{'Outputs': [{'OutputName': 'sentiment-train',
   'AppManaged': False,
   'S3Output': {'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-train',
    'LocalPath': '/opt/ml/processing/output/sentiment/train',
    'S3UploadMode': 'EndOfJob'}},
  {'OutputName': 'sentiment-validation',
   'AppManaged': False,
   'S3Output': {'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-validation',
    'LocalPath': '/opt/ml/processing/output/sentiment/validation',
    'S3UploadMode': 'EndOfJob'}},
  {'OutputName': 'sentiment-test',
   'AppManaged': False,
   'S3Output': {'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-test',
    'LocalPath': '/opt/ml/processing/output/sentiment/test',
    'S3UploadMode': 'EndOfJob'}}]}</code></pre>
</div>
</div>
</section>
</section>
<section id="configure-training-step" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="configure-training-step"><span class="header-section-number">6</span> Configure training step</h2>
<section id="define-parameters" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="define-parameters"><span class="header-section-number">6.1</span> Define parameters</h3>
<p>Setup the parameters for the workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>freeze_bert_layer <span class="op">=</span> ParameterString(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"FreezeBertLayer"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"False"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Epochs"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">3</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> ParameterFloat(</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"LearningRate"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="fl">0.00001</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>train_batch_size <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainBatchSize"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">64</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>train_steps_per_epoch <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainStepsPerEpoch"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">50</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>validation_batch_size <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ValidationBatchSize"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">64</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>validation_steps_per_epoch <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ValidationStepsPerEpoch"</span>,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">50</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Seed"</span>,</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">42</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>run_validation <span class="op">=</span> ParameterString(</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"RunValidation"</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"True"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>train_instance_count <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainInstanceCount"</span>,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">1</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>train_instance_type <span class="op">=</span> ParameterString(</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainInstanceType"</span>,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"ml.c5.9xlarge"</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>train_volume_size <span class="op">=</span> ParameterInteger(</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"TrainVolumeSize"</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">256</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>input_mode <span class="op">=</span> ParameterString(</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"InputMode"</span>,</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"File"</span>,</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-hyper-parameters" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="configure-hyper-parameters"><span class="header-section-number">6.2</span> Configure hyper-parameters</h3>
<p>Setup the dictionary that will be passed into the hyperparameters argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>hyperparameters<span class="op">=</span>{</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_seq_length'</span>: max_seq_length,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'freeze_bert_layer'</span>: freeze_bert_layer,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'epochs'</span>: epochs,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: learning_rate,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'train_batch_size'</span>: train_batch_size,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'train_steps_per_epoch'</span>: train_steps_per_epoch,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'validation_batch_size'</span>: validation_batch_size,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'validation_steps_per_epoch'</span>: validation_steps_per_epoch,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'seed'</span>: seed,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'run_validation'</span>: run_validation</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-model-evaluation-metrics" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="configure-model-evaluation-metrics"><span class="header-section-number">6.3</span> Configure model-evaluation metrics</h3>
<p>Choose loss and accuracy as the evaluation metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>metric_definitions <span class="op">=</span> [</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>     {<span class="st">'Name'</span>: <span class="st">'validation:loss'</span>, <span class="st">'Regex'</span>: <span class="st">'val_loss: ([0-9.]+)'</span>},</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>     {<span class="st">'Name'</span>: <span class="st">'validation:accuracy'</span>, <span class="st">'Regex'</span>: <span class="st">'val_acc: ([0-9.]+)'</span>},</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-the-pytorchestimator" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="configure-the-pytorchestimator"><span class="header-section-number">6.4</span> Configure the <code>PyTorchEstimator</code></h3>
<p>Let’s configure an estimator and the input dataset. A typical training script loads data from the input channels, configures training with hyperparameters, trains a model, and saves a model to <code>model_dir</code> so that it can be hosted later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.pytorch <span class="im">import</span> PyTorch <span class="im">as</span> PyTorchEstimator</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>estimator <span class="op">=</span> PyTorchEstimator(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    entry_point<span class="op">=</span><span class="st">'train.py'</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    source_dir<span class="op">=</span><span class="st">'src'</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span>train_instance_count,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>train_instance_type,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    volume_size<span class="op">=</span>train_volume_size,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span><span class="st">'py3'</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">'1.6.0'</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    hyperparameters<span class="op">=</span>hyperparameters,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    metric_definitions<span class="op">=</span>metric_definitions,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    input_mode<span class="op">=</span>input_mode</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setup-pipeline-step-caching" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="setup-pipeline-step-caching"><span class="header-section-number">6.5</span> Setup pipeline step caching</h3>
<p>Step signature caching allows SageMaker Pipelines, before executing a step, to find a previous execution of a step that was called using the same arguments. Cache hit gets created if the previous execution is found. Then during execution instead of recomputing the step, pipelines propagates the values from the cache hit.</p>
<p>Timeout period is defined using <a href="https://en.wikipedia.org/wiki/ISO_8601#Durations">ISO 8601</a> format, it can contain a year, month, week, day, hour, and minute value.</p>
<p>More details on SageMaker Pipeline step caching can be found <a href="https://docs.aws.amazon.com/sagemaker/latest/dg/pipelines-caching.html">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> CacheConfig</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>cache_config <span class="op">=</span> CacheConfig(enable_caching<span class="op">=</span><span class="va">True</span>, expire_after<span class="op">=</span><span class="st">"PT1H"</span>) <span class="co"># PT1H represents `one hour`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-the-trainingstep" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="configure-the-trainingstep"><span class="header-section-number">6.6</span> Configure the <code>TrainingStep</code></h3>
<p>Now we configure the <code>TrainingStep</code> calling the outputs of the processing step:</p>
<div class="cell" data-outputid="1cb4774c-ee9a-4e9d-c088-b062621abaa9">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.inputs <span class="im">import</span> TrainingInput</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> TrainingStep</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>training_step <span class="op">=</span> TrainingStep(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'Train'</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    estimator<span class="op">=</span>estimator,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>{</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'train'</span>: TrainingInput(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>            s3_data<span class="op">=</span>processing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sentiment-train'</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>            ].S3Output.S3Uri,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>            content_type<span class="op">=</span><span class="st">'text/csv'</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'validation'</span>: TrainingInput(</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>            s3_data<span class="op">=</span>processing_step.properties.ProcessingOutputConfig.Outputs[</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sentiment-validation'</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>            ].S3Output.S3Uri,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>            content_type<span class="op">=</span><span class="st">'text/csv'</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    cache_config<span class="op">=</span>cache_config</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(training_step)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TrainingStep(name='Train', step_type=&lt;StepTypeEnum.TRAINING: 'Training'&gt;)</code></pre>
</div>
</div>
<p>We will use the <code>__dict__</code> method to print out attributes of the training step properties. Briefly review the result. The attributes match the object model of the <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_DescribeTrainingJob.html">DescribeTrainingJob</a> response object.</p>
<div class="cell" data-outputid="593d96f5-84ad-46e2-c89e-c2d19fe5f68a">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>training_step.properties.__dict__ </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>{'_path': 'Steps.Train',
 '_shape_name': 'DescribeTrainingJobResponse',
 'TrainingJobName': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101310&gt;,
 'TrainingJobArn': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101350&gt;,
 'TuningJobArn': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101390&gt;,
 'LabelingJobArn': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf51013d0&gt;,
 'AutoMLJobArn': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101210&gt;,
 'ModelArtifacts': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101250&gt;,
 'TrainingJobStatus': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf51012d0&gt;,
 'SecondaryStatus': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101110&gt;,
 'FailureReason': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101150&gt;,
 'HyperParameters': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101190&gt;,
 'AlgorithmSpecification': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf51011d0&gt;,
 'RoleArn': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101850&gt;,
 'InputDataConfig': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf5101750&gt;,
 'OutputDataConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5101490&gt;,
 'ResourceConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf51015d0&gt;,
 'VpcConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424e10&gt;,
 'StoppingCondition': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424350&gt;,
 'CreationTime': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424910&gt;,
 'TrainingStartTime': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424750&gt;,
 'TrainingEndTime': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424950&gt;,
 'LastModifiedTime': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424550&gt;,
 'SecondaryStatusTransitions': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf5424a10&gt;,
 'FinalMetricDataList': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf5424590&gt;,
 'EnableNetworkIsolation': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424e50&gt;,
 'EnableInterContainerTrafficEncryption': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424690&gt;,
 'EnableManagedSpotTraining': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424150&gt;,
 'CheckpointConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424fd0&gt;,
 'TrainingTimeInSeconds': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424490&gt;,
 'BillableTimeInSeconds': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf5424ad0&gt;,
 'DebugHookConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf54246d0&gt;,
 'ExperimentConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7d50&gt;,
 'DebugRuleConfigurations': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf53a7890&gt;,
 'TensorBoardOutputConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7e50&gt;,
 'DebugRuleEvaluationStatuses': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf53a7dd0&gt;,
 'ProfilerConfig': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7d90&gt;,
 'ProfilerRuleConfigurations': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf53a79d0&gt;,
 'ProfilerRuleEvaluationStatuses': &lt;sagemaker.workflow.properties.PropertiesList at 0x7fcdf53a7410&gt;,
 'ProfilingStatus': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7ad0&gt;,
 'RetryStrategy': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7a10&gt;,
 'Environment': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7950&gt;,
 'WarmPoolStatus': &lt;sagemaker.workflow.properties.Properties at 0x7fcdf53a7f10&gt;}</code></pre>
</div>
</div>
</section>
</section>
<section id="configure-model-evaluation-step" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="configure-model-evaluation-step"><span class="header-section-number">7</span> Configure model-evaluation step</h2>
<p>First, we will develop an evaluation script that will be specified in the model evaluation processing step. The evaluation script users the trained model and the test dataset to produce a JSON file with classification evaluation metrics such as accuracy.</p>
<p>The evaluation script performs the following steps: * loads in the model * reads in the test data * issues a bunch of predictions against the test data * builds a classification report, including accuracy * saves the evaluation report to the evaluation directory</p>
<p>Create an instance of the <code>SKLearnProcessor</code> to run our evaluation script as a scikit-learn-based SageMaker processing job.</p>
<div class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.sklearn.processing <span class="im">import</span> SKLearnProcessor</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>evaluation_processor <span class="op">=</span> SKLearnProcessor(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    framework_version<span class="op">=</span><span class="st">'0.23-1'</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>processing_instance_type,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    instance_count<span class="op">=</span>processing_instance_count,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    env<span class="op">=</span>{<span class="st">'AWS_DEFAULT_REGION'</span>: region},</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    max_runtime_in_seconds<span class="op">=</span><span class="dv">7200</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setup the output <code>PropertyFile</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.properties <span class="im">import</span> PropertyFile</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>evaluation_report <span class="op">=</span> PropertyFile(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'EvaluationReport'</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    output_name<span class="op">=</span><span class="st">'metrics'</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span><span class="st">'evaluation.json'</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we use the processor instance to construct a <code>ProcessingStep</code>, along with the input and output channels and the code that will be executed when the pipeline invokes pipeline execution. This is very similar to a processor instance’s <code>run</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.processing <span class="im">import</span> ProcessingInput, ProcessingOutput</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>evaluation_step <span class="op">=</span> ProcessingStep(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'EvaluateModel'</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    processor<span class="op">=</span>evaluation_processor,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    code<span class="op">=</span><span class="st">'src/evaluate_model_metrics.py'</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>[</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        ProcessingInput(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>            source<span class="op">=</span>training_step.properties.ModelArtifacts.S3ModelArtifacts,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>            destination<span class="op">=</span><span class="st">'/opt/ml/processing/input/model'</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        ProcessingInput(</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>            source<span class="op">=</span>processing_step.properties.ProcessingOutputConfig.Outputs[<span class="st">'sentiment-test'</span>].S3Output.S3Uri,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>            destination<span class="op">=</span><span class="st">'/opt/ml/processing/input/data'</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    outputs<span class="op">=</span>[</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        ProcessingOutput(output_name<span class="op">=</span><span class="st">'metrics'</span>, </span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                         s3_upload_mode<span class="op">=</span><span class="st">'EndOfJob'</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                         source<span class="op">=</span><span class="st">'/opt/ml/processing/output/metrics/'</span>),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    job_arguments<span class="op">=</span>[</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'--max-seq-length'</span>, <span class="bu">str</span>(max_seq_length.default_value),</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    property_files<span class="op">=</span>[evaluation_report],</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configure-and-register-model-step" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="configure-and-register-model-step"><span class="header-section-number">8</span> Configure and register model step</h2>
<section id="configure-the-model-for-deployment" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="configure-the-model-for-deployment"><span class="header-section-number">8.1</span> Configure the model for deployment</h3>
<p>We will now use the estimator instance that was used for the training step to construct an instance of <code>RegisterModel</code>. The result of executing <code>RegisterModel</code> in a pipeline is a model package. A model package is a reusable model artifacts abstraction that packages all ingredients necessary for inference. Primarily, it consists of an inference specification that defines the inference image to use along with an optional model weights location.</p>
<p>A model package group is a collection of model packages. You can create a model package group for a specific ML business problem, and you can keep adding versions/model packages into it. Typically, customers are expected to create a ModelPackageGroup for a SageMaker workflow pipeline so that they can keep adding versions/model packages to the group for every workflow pipeline run.</p>
<p>The construction of <code>RegisterModel</code> is very similar to an estimator instance’s <code>register</code> method, for those familiar with the existing Python SDK.</p>
<p>In particular, we will pass in the <code>S3ModelArtifacts</code> from the <code>training_step</code> properties.</p>
<p>Of note, here we will be provided a specific model package group name which will be used in the Model Registry and Continuous Integration/Continuous Deployment (CI/CD) work later on. Let’s setup the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_approval_status <span class="op">=</span> ParameterString(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"ModelApprovalStatus"</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"PendingManualApproval"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>deploy_instance_type <span class="op">=</span> ParameterString(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"DeployInstanceType"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="st">"ml.m5.large"</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>deploy_instance_count <span class="op">=</span> ParameterInteger(</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"DeployInstanceCount"</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="dv">1</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="801217b4-4c41-46bd-c1e7-e3eecf95cb47">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model_package_group_name <span class="op">=</span> <span class="ss">f"BERT-Reviews-</span><span class="sc">{</span>timestamp<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_package_group_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BERT-Reviews-1676208665</code></pre>
</div>
</div>
<p>Configure the <code>ModelMetrics</code> to be stored as metadata.</p>
<div class="cell" data-outputid="686e843f-9bf2-49ea-c0cb-e530838f774a">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model_metrics <span class="im">import</span> MetricsSource, ModelMetrics </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="op">=</span> ModelMetrics(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    model_statistics<span class="op">=</span>MetricsSource(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        s3_uri<span class="op">=</span><span class="st">"</span><span class="sc">{}</span><span class="st">/evaluation.json"</span>.<span class="bu">format</span>(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>            evaluation_step.arguments[<span class="st">"ProcessingOutputConfig"</span>][<span class="st">"Outputs"</span>][<span class="dv">0</span>][<span class="st">"S3Output"</span>][<span class="st">"S3Uri"</span>]</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        content_type<span class="op">=</span><span class="st">"application/json"</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;sagemaker.model_metrics.ModelMetrics object at 0x7fcdf40cd5d0&gt;</code></pre>
</div>
</div>
<p>Define deployment image for inference.</p>
<div class="cell" data-outputid="c9e17fee-616b-4f13-8431-c3eab06105c8">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>inference_image_uri <span class="op">=</span> sagemaker.image_uris.retrieve(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    framework<span class="op">=</span><span class="st">"pytorch"</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    region<span class="op">=</span>region,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    version<span class="op">=</span><span class="st">"1.6.0"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    py_version<span class="op">=</span><span class="st">"py36"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>deploy_instance_type,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    image_scope<span class="op">=</span><span class="st">"inference"</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inference_image_uri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-inference:1.6.0-cpu-py36</code></pre>
</div>
</div>
</section>
<section id="register-the-model-for-deployment" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="register-the-model-for-deployment"><span class="header-section-number">8.2</span> Register the model for deployment</h3>
<p>Let’s now configure the register model step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.step_collections <span class="im">import</span> RegisterModel</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>register_step <span class="op">=</span> RegisterModel(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"RegisterModel"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    estimator<span class="op">=</span>estimator,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>inference_image_uri, </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>training_step.properties.ModelArtifacts.S3ModelArtifacts,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    content_types<span class="op">=</span>[<span class="st">"application/jsonlines"</span>],</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    response_types<span class="op">=</span>[<span class="st">"application/jsonlines"</span>],</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    inference_instances<span class="op">=</span>[deploy_instance_type],</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    transform_instances<span class="op">=</span>[deploy_instance_type], </span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    model_package_group_name<span class="op">=</span>model_package_group_name,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    approval_status<span class="op">=</span>model_approval_status,</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    model_metrics<span class="op">=</span>model_metrics</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-model-for-deployment-step" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="create-model-for-deployment-step"><span class="header-section-number">9</span> Create model for deployment step</h2>
<p>Let’s configure the model for deployment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.model <span class="im">import</span> Model</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> <span class="st">'bert-model-</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(timestamp)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>model_name,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    image_uri<span class="op">=</span>inference_image_uri, </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    model_data<span class="op">=</span>training_step.properties.ModelArtifacts.S3ModelArtifacts,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sess,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    role<span class="op">=</span>role,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we configure create model input:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.inputs <span class="im">import</span> CreateModelInput</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>create_inputs <span class="op">=</span> CreateModelInput(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    instance_type<span class="op">=</span>deploy_instance_type, </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly we configure the create model step for the workflow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.steps <span class="im">import</span> CreateModelStep</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>create_step <span class="op">=</span> CreateModelStep(</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"CreateModel"</span>,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>model, </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    inputs<span class="op">=</span>create_inputs, </span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="check-accuracy-condition-step" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="check-accuracy-condition-step"><span class="header-section-number">10</span> Check accuracy condition step</h2>
<p>Finally, we would like to only register this model if the accuracy of the model, as determined by our evaluation step <code>evaluation_step</code>, exceeded some value. A <code>ConditionStep</code> allows for pipelines to support conditional execution in the pipeline DAG based on conditions of step properties.</p>
<p>Below, we will:</p>
<ul>
<li>define a minimum accuracy value as a parameter</li>
<li>define a <code>ConditionGreaterThan</code> on the accuracy value found in the output of the evaluation step, <code>evaluation_step</code>.</li>
<li>use the condition in the list of conditions in a <code>ConditionStep</code></li>
<li>pass the <code>RegisterModel</code> step collection into the <code>if_steps</code> of the <code>ConditionStep</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>min_accuracy_value <span class="op">=</span> ParameterFloat(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"MinAccuracyValue"</span>,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    default_value<span class="op">=</span><span class="fl">0.33</span> <span class="co"># random choice from three classes</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.conditions <span class="im">import</span> ConditionGreaterThanOrEqualTo</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.condition_step <span class="im">import</span> (</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    ConditionStep,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    JsonGet,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>minimum_accuracy_condition <span class="op">=</span> ConditionGreaterThanOrEqualTo(</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    left<span class="op">=</span>JsonGet(</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        step<span class="op">=</span>evaluation_step,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        property_file<span class="op">=</span>evaluation_report,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        json_path<span class="op">=</span><span class="st">"metrics.accuracy.value"</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    right<span class="op">=</span>min_accuracy_value <span class="co"># minimum accuracy threshold</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>minimum_accuracy_condition_step <span class="op">=</span> ConditionStep(</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"AccuracyCondition"</span>,</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    conditions<span class="op">=</span>[minimum_accuracy_condition],</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    if_steps<span class="op">=</span>[register_step, create_step], <span class="co"># successfully exceeded or equaled the minimum accuracy, continue with model registration</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    else_steps<span class="op">=</span>[], <span class="co"># did not exceed the minimum accuracy, the model will not be registered</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-pipeline" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="create-pipeline"><span class="header-section-number">11</span> Create pipeline</h2>
<section id="define-a-pipeline-of-parameters-steps-and-conditions" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="define-a-pipeline-of-parameters-steps-and-conditions"><span class="header-section-number">11.1</span> Define a pipeline of parameters, steps, and conditions</h3>
<p>Let’s tie it all up into a workflow pipeline so we can execute it, and even schedule it.</p>
<p>A pipeline requires a <code>name</code>, <code>parameters</code>, and <code>steps</code>. Names must be unique within an <code>(account, region)</code> pair so you can append the timestamp to the name to reduce the chance of name conflict.</p>
<p>Note:</p>
<ul>
<li>All the parameters used in the definitions must be present.</li>
<li>Steps passed into the pipeline need not be in the order of execution. The SageMaker workflow service will resolve the <em>data dependency</em> DAG as steps the execution complete.</li>
<li>Steps must be unique to either pipeline step list or a single condition step if/else list.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.workflow.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>pipeline_name,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span>[</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        input_data,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        processing_instance_count,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        processing_instance_type,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>        max_seq_length,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        balance_dataset,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        train_split_percentage,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        validation_split_percentage,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        test_split_percentage,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        feature_store_offline_prefix,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        feature_group_name,</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>        epochs,</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>        learning_rate,</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>        train_batch_size,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>        train_steps_per_epoch,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>        validation_batch_size,</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>        validation_steps_per_epoch,</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>        freeze_bert_layer,</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>        seed,</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>        train_instance_count,</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        train_instance_type,</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>        train_volume_size,        </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>        input_mode,</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>        run_validation,</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>        min_accuracy_value,</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>        model_approval_status,</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>        deploy_instance_type,</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>        deploy_instance_count</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[processing_step, training_step, evaluation_step, minimum_accuracy_condition_step],</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sess,</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s examine the JSON of the pipeline definition that meets the SageMaker Workflow Pipeline DSL specification.</p>
<p>By examining the definition, you are also confirming that the pipeline was well-defined, and that the parameters and step properties resolve correctly.</p>
<div class="cell" data-outputid="27f05fa4-8980-4dbb-b3e9-52ba548492b0" data-scrolled="true">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>definition <span class="op">=</span> json.loads(pipeline.definition())</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>pprint(definition)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No finished training job found associated with this estimator. Please make sure this estimator is only used for building workflow config</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Metadata': {},
 'Parameters': [{'DefaultValue': 's3://dlai-practical-data-science/data/raw/',
                 'Name': 'InputData',
                 'Type': 'String'},
                {'DefaultValue': 1,
                 'Name': 'ProcessingInstanceCount',
                 'Type': 'Integer'},
                {'DefaultValue': 'ml.c5.2xlarge',
                 'Name': 'ProcessingInstanceType',
                 'Type': 'String'},
                {'DefaultValue': 128,
                 'Name': 'MaxSeqLength',
                 'Type': 'Integer'},
                {'DefaultValue': 'True',
                 'Name': 'BalanceDataset',
                 'Type': 'String'},
                {'DefaultValue': 0.9,
                 'Name': 'TrainSplitPercentage',
                 'Type': 'Float'},
                {'DefaultValue': 0.05,
                 'Name': 'ValidationSplitPercentage',
                 'Type': 'Float'},
                {'DefaultValue': 0.05,
                 'Name': 'TestSplitPercentage',
                 'Type': 'Float'},
                {'DefaultValue': 'reviews-feature-store-1676208665',
                 'Name': 'FeatureStoreOfflinePrefix',
                 'Type': 'String'},
                {'DefaultValue': 'reviews-feature-group-1676208665',
                 'Name': 'FeatureGroupName',
                 'Type': 'String'},
                {'DefaultValue': 3, 'Name': 'Epochs', 'Type': 'Integer'},
                {'DefaultValue': 1e-05,
                 'Name': 'LearningRate',
                 'Type': 'Float'},
                {'DefaultValue': 64,
                 'Name': 'TrainBatchSize',
                 'Type': 'Integer'},
                {'DefaultValue': 50,
                 'Name': 'TrainStepsPerEpoch',
                 'Type': 'Integer'},
                {'DefaultValue': 64,
                 'Name': 'ValidationBatchSize',
                 'Type': 'Integer'},
                {'DefaultValue': 50,
                 'Name': 'ValidationStepsPerEpoch',
                 'Type': 'Integer'},
                {'DefaultValue': 'False',
                 'Name': 'FreezeBertLayer',
                 'Type': 'String'},
                {'DefaultValue': 42, 'Name': 'Seed', 'Type': 'Integer'},
                {'DefaultValue': 1,
                 'Name': 'TrainInstanceCount',
                 'Type': 'Integer'},
                {'DefaultValue': 'ml.c5.9xlarge',
                 'Name': 'TrainInstanceType',
                 'Type': 'String'},
                {'DefaultValue': 256,
                 'Name': 'TrainVolumeSize',
                 'Type': 'Integer'},
                {'DefaultValue': 'File', 'Name': 'InputMode', 'Type': 'String'},
                {'DefaultValue': 'True',
                 'Name': 'RunValidation',
                 'Type': 'String'},
                {'DefaultValue': 0.33,
                 'Name': 'MinAccuracyValue',
                 'Type': 'Float'},
                {'DefaultValue': 'PendingManualApproval',
                 'Name': 'ModelApprovalStatus',
                 'Type': 'String'},
                {'DefaultValue': 'ml.m5.large',
                 'Name': 'DeployInstanceType',
                 'Type': 'String'},
                {'DefaultValue': 1,
                 'Name': 'DeployInstanceCount',
                 'Type': 'Integer'}],
 'Steps': [{'Arguments': {'AppSpecification': {'ContainerArguments': ['--train-split-percentage',
                                                                      '0.9',
                                                                      '--validation-split-percentage',
                                                                      '0.05',
                                                                      '--test-split-percentage',
                                                                      '0.05',
                                                                      '--balance-dataset',
                                                                      'True',
                                                                      '--max-seq-length',
                                                                      '128',
                                                                      '--feature-store-offline-prefix',
                                                                      'reviews-feature-store-1676208665',
                                                                      '--feature-group-name',
                                                                      'reviews-feature-group-1676208665'],
                                               'ContainerEntrypoint': ['python3',
                                                                       '/opt/ml/processing/input/code/prepare_data.py'],
                                               'ImageUri': '683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:0.23-1-cpu-py3'},
                          'Environment': {'AWS_DEFAULT_REGION': 'us-east-1'},
                          'ProcessingInputs': [{'AppManaged': False,
                                                'InputName': 'raw-input-data',
                                                'S3Input': {'LocalPath': '/opt/ml/processing/input/data/',
                                                            'S3CompressionType': 'None',
                                                            'S3DataDistributionType': 'ShardedByS3Key',
                                                            'S3DataType': 'S3Prefix',
                                                            'S3InputMode': 'File',
                                                            'S3Uri': {'Get': 'Parameters.InputData'}}},
                                               {'AppManaged': False,
                                                'InputName': 'code',
                                                'S3Input': {'LocalPath': '/opt/ml/processing/input/code',
                                                            'S3CompressionType': 'None',
                                                            'S3DataDistributionType': 'FullyReplicated',
                                                            'S3DataType': 'S3Prefix',
                                                            'S3InputMode': 'File',
                                                            'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-37-28-563/input/code/prepare_data.py'}}],
                          'ProcessingOutputConfig': {'Outputs': [{'AppManaged': False,
                                                                  'OutputName': 'sentiment-train',
                                                                  'S3Output': {'LocalPath': '/opt/ml/processing/output/sentiment/train',
                                                                               'S3UploadMode': 'EndOfJob',
                                                                               'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-train'}},
                                                                 {'AppManaged': False,
                                                                  'OutputName': 'sentiment-validation',
                                                                  'S3Output': {'LocalPath': '/opt/ml/processing/output/sentiment/validation',
                                                                               'S3UploadMode': 'EndOfJob',
                                                                               'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-validation'}},
                                                                 {'AppManaged': False,
                                                                  'OutputName': 'sentiment-test',
                                                                  'S3Output': {'LocalPath': '/opt/ml/processing/output/sentiment/test',
                                                                               'S3UploadMode': 'EndOfJob',
                                                                               'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-test'}}]},
                          'ProcessingResources': {'ClusterConfig': {'InstanceCount': {'Get': 'Parameters.ProcessingInstanceCount'},
                                                                    'InstanceType': {'Get': 'Parameters.ProcessingInstanceType'},
                                                                    'VolumeSizeInGB': 30}},
                          'RoleArn': 'arn:aws:iam::912822595625:role/sagemaker-studio-vpc-firewall-us-east-1-sagemaker-execution-role'},
            'Name': 'Processing',
            'Type': 'Processing'},
           {'Arguments': {'AlgorithmSpecification': {'EnableSageMakerMetricsTimeSeries': True,
                                                     'MetricDefinitions': [{'Name': 'validation:loss',
                                                                            'Regex': 'val_loss: '
                                                                                     '([0-9.]+)'},
                                                                           {'Name': 'validation:accuracy',
                                                                            'Regex': 'val_acc: '
                                                                                     '([0-9.]+)'}],
                                                     'TrainingImage': '763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-training:1.6.0-cpu-py3',
                                                     'TrainingInputMode': {'Get': 'Parameters.InputMode'}},
                          'DebugHookConfig': {'CollectionConfigurations': [],
                                              'S3OutputPath': 's3://sagemaker-us-east-1-912822595625/'},
                          'HyperParameters': {'epochs': '3',
                                              'freeze_bert_layer': '"False"',
                                              'learning_rate': '1e-05',
                                              'max_seq_length': '128',
                                              'run_validation': '"True"',
                                              'sagemaker_container_log_level': '20',
                                              'sagemaker_job_name': '"pytorch-training-2023-02-12-13-37-28-707"',
                                              'sagemaker_program': '"train.py"',
                                              'sagemaker_region': '"us-east-1"',
                                              'sagemaker_submit_directory': '"s3://sagemaker-us-east-1-912822595625/pytorch-training-2023-02-12-13-37-28-707/source/sourcedir.tar.gz"',
                                              'seed': '42',
                                              'train_batch_size': '64',
                                              'train_steps_per_epoch': '50',
                                              'validation_batch_size': '64',
                                              'validation_steps_per_epoch': '50'},
                          'InputDataConfig': [{'ChannelName': 'train',
                                               'ContentType': 'text/csv',
                                               'DataSource': {'S3DataSource': {'S3DataDistributionType': 'FullyReplicated',
                                                                               'S3DataType': 'S3Prefix',
                                                                               'S3Uri': {'Get': "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-train'].S3Output.S3Uri"}}}},
                                              {'ChannelName': 'validation',
                                               'ContentType': 'text/csv',
                                               'DataSource': {'S3DataSource': {'S3DataDistributionType': 'FullyReplicated',
                                                                               'S3DataType': 'S3Prefix',
                                                                               'S3Uri': {'Get': "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-validation'].S3Output.S3Uri"}}}}],
                          'OutputDataConfig': {'S3OutputPath': 's3://sagemaker-us-east-1-912822595625/'},
                          'ProfilerConfig': {'S3OutputPath': 's3://sagemaker-us-east-1-912822595625/'},
                          'ProfilerRuleConfigurations': [{'RuleConfigurationName': 'ProfilerReport-1676209048',
                                                          'RuleEvaluatorImage': '503895931360.dkr.ecr.us-east-1.amazonaws.com/sagemaker-debugger-rules:latest',
                                                          'RuleParameters': {'rule_to_invoke': 'ProfilerReport'}}],
                          'ResourceConfig': {'InstanceCount': {'Get': 'Parameters.TrainInstanceCount'},
                                             'InstanceType': {'Get': 'Parameters.TrainInstanceType'},
                                             'VolumeSizeInGB': {'Get': 'Parameters.TrainVolumeSize'}},
                          'RoleArn': 'arn:aws:iam::912822595625:role/sagemaker-studio-vpc-firewall-us-east-1-sagemaker-execution-role',
                          'StoppingCondition': {'MaxRuntimeInSeconds': 86400}},
            'CacheConfig': {'Enabled': True, 'ExpireAfter': 'PT1H'},
            'Name': 'Train',
            'Type': 'Training'},
           {'Arguments': {'AppSpecification': {'ContainerArguments': ['--max-seq-length',
                                                                      '128'],
                                               'ContainerEntrypoint': ['python3',
                                                                       '/opt/ml/processing/input/code/evaluate_model_metrics.py'],
                                               'ImageUri': '683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:0.23-1-cpu-py3'},
                          'Environment': {'AWS_DEFAULT_REGION': 'us-east-1'},
                          'ProcessingInputs': [{'AppManaged': False,
                                                'InputName': 'input-1',
                                                'S3Input': {'LocalPath': '/opt/ml/processing/input/model',
                                                            'S3CompressionType': 'None',
                                                            'S3DataDistributionType': 'FullyReplicated',
                                                            'S3DataType': 'S3Prefix',
                                                            'S3InputMode': 'File',
                                                            'S3Uri': {'Get': 'Steps.Train.ModelArtifacts.S3ModelArtifacts'}}},
                                               {'AppManaged': False,
                                                'InputName': 'input-2',
                                                'S3Input': {'LocalPath': '/opt/ml/processing/input/data',
                                                            'S3CompressionType': 'None',
                                                            'S3DataDistributionType': 'FullyReplicated',
                                                            'S3DataType': 'S3Prefix',
                                                            'S3InputMode': 'File',
                                                            'S3Uri': {'Get': "Steps.Processing.ProcessingOutputConfig.Outputs['sentiment-test'].S3Output.S3Uri"}}},
                                               {'AppManaged': False,
                                                'InputName': 'code',
                                                'S3Input': {'LocalPath': '/opt/ml/processing/input/code',
                                                            'S3CompressionType': 'None',
                                                            'S3DataDistributionType': 'FullyReplicated',
                                                            'S3DataType': 'S3Prefix',
                                                            'S3InputMode': 'File',
                                                            'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-37-29-187/input/code/evaluate_model_metrics.py'}}],
                          'ProcessingOutputConfig': {'Outputs': [{'AppManaged': False,
                                                                  'OutputName': 'metrics',
                                                                  'S3Output': {'LocalPath': '/opt/ml/processing/output/metrics/',
                                                                               'S3UploadMode': 'EndOfJob',
                                                                               'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-35-32-414/output/metrics'}}]},
                          'ProcessingResources': {'ClusterConfig': {'InstanceCount': {'Get': 'Parameters.ProcessingInstanceCount'},
                                                                    'InstanceType': {'Get': 'Parameters.ProcessingInstanceType'},
                                                                    'VolumeSizeInGB': 30}},
                          'RoleArn': 'arn:aws:iam::912822595625:role/sagemaker-studio-vpc-firewall-us-east-1-sagemaker-execution-role',
                          'StoppingCondition': {'MaxRuntimeInSeconds': 7200}},
            'Name': 'EvaluateModel',
            'PropertyFiles': [{'FilePath': 'evaluation.json',
                               'OutputName': 'metrics',
                               'PropertyFileName': 'EvaluationReport'}],
            'Type': 'Processing'},
           {'Arguments': {'Conditions': [{'LeftValue': {'Std:JsonGet': {'Path': 'metrics.accuracy.value',
                                                                        'PropertyFile': {'Get': 'Steps.EvaluateModel.PropertyFiles.EvaluationReport'}}},
                                          'RightValue': {'Get': 'Parameters.MinAccuracyValue'},
                                          'Type': 'GreaterThanOrEqualTo'}],
                          'ElseSteps': [],
                          'IfSteps': [{'Arguments': {'InferenceSpecification': {'Containers': [{'Image': '763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-inference:1.6.0-cpu-py36',
                                                                                                'ModelDataUrl': {'Get': 'Steps.Train.ModelArtifacts.S3ModelArtifacts'}}],
                                                                                'SupportedContentTypes': ['application/jsonlines'],
                                                                                'SupportedRealtimeInferenceInstanceTypes': [{'Get': 'Parameters.DeployInstanceType'}],
                                                                                'SupportedResponseMIMETypes': ['application/jsonlines'],
                                                                                'SupportedTransformInstanceTypes': [{'Get': 'Parameters.DeployInstanceType'}]},
                                                     'ModelApprovalStatus': {'Get': 'Parameters.ModelApprovalStatus'},
                                                     'ModelMetrics': {'ModelQuality': {'Statistics': {'ContentType': 'application/json',
                                                                                                      'S3Uri': 's3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-35-32-414/output/metrics/evaluation.json'}}},
                                                     'ModelPackageGroupName': 'BERT-Reviews-1676208665'},
                                       'Name': 'RegisterModel',
                                       'Type': 'RegisterModel'},
                                      {'Arguments': {'ExecutionRoleArn': 'arn:aws:iam::912822595625:role/sagemaker-studio-vpc-firewall-us-east-1-sagemaker-execution-role',
                                                     'PrimaryContainer': {'Environment': {},
                                                                          'Image': '763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-inference:1.6.0-cpu-py36',
                                                                          'ModelDataUrl': {'Get': 'Steps.Train.ModelArtifacts.S3ModelArtifacts'}}},
                                       'Name': 'CreateModel',
                                       'Type': 'Model'}]},
            'Name': 'AccuracyCondition',
            'Type': 'Condition'}],
 'Version': '2020-12-01'}</code></pre>
</div>
</div>
<p>Now we create a pipeline using the <code>create</code> method and then print the Amazon Resource Name (ARN) of it.</p>
<div class="cell" data-outputid="8c60e97f-d45b-4ea1-be6e-ee42b7c36822">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> pipeline.create(role_arn<span class="op">=</span>role)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>pipeline_arn <span class="op">=</span> response[<span class="st">"PipelineArn"</span>]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pipeline_arn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No finished training job found associated with this estimator. Please make sure this estimator is only used for building workflow config</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665</code></pre>
</div>
</div>
</section>
<section id="start-pipeline" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="start-pipeline"><span class="header-section-number">11.2</span> Start Pipeline</h3>
<p>Let’s submit our pipeline definition to the Amazon SageMaker Pipeline service. The role passed in will be used by the service to create all the jobs defined in the steps. We will start the pipeline using the parameters passed into the <code>start()</code> function.</p>
<div class="cell" data-outputid="fed7b243-649f-4834-c4ee-42c21e3ce00d">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>execution <span class="op">=</span> pipeline.start(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    parameters<span class="op">=</span><span class="bu">dict</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        InputData<span class="op">=</span>raw_input_data_s3_uri,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        ProcessingInstanceCount<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        ProcessingInstanceType<span class="op">=</span><span class="st">'ml.c5.2xlarge'</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        MaxSeqLength<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        BalanceDataset<span class="op">=</span><span class="st">'True'</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        TrainSplitPercentage<span class="op">=</span><span class="fl">0.9</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>        ValidationSplitPercentage<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>        TestSplitPercentage<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        FeatureStoreOfflinePrefix<span class="op">=</span><span class="st">'reviews-feature-store-'</span><span class="op">+</span><span class="bu">str</span>(timestamp),</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        FeatureGroupName<span class="op">=</span><span class="st">'reviews-feature-group-'</span><span class="op">+</span><span class="bu">str</span>(timestamp),</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        Epochs<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        LearningRate<span class="op">=</span><span class="fl">0.000012</span>,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        TrainBatchSize<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>        TrainStepsPerEpoch<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>        ValidationBatchSize<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>        ValidationStepsPerEpoch<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>        FreezeBertLayer<span class="op">=</span><span class="st">'False'</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>        Seed<span class="op">=</span><span class="dv">42</span>,         </span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        TrainInstanceCount<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        TrainInstanceType<span class="op">=</span><span class="st">'ml.c5.9xlarge'</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        TrainVolumeSize<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        InputMode<span class="op">=</span><span class="st">'File'</span>,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        RunValidation<span class="op">=</span><span class="st">'True'</span>,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        MinAccuracyValue<span class="op">=</span><span class="fl">0.01</span>,</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>        ModelApprovalStatus<span class="op">=</span><span class="st">'PendingManualApproval'</span>, </span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>        DeployInstanceType<span class="op">=</span><span class="st">'ml.m5.large'</span>,</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        DeployInstanceCount<span class="op">=</span><span class="dv">1</span> </span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(execution.arn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665/execution/h4inlmq7fqwk</code></pre>
</div>
</div>
</section>
<section id="wait-for-pipeline-execution" class="level3" data-number="11.3">
<h3 data-number="11.3" class="anchored" data-anchor-id="wait-for-pipeline-execution"><span class="header-section-number">11.3</span> Wait for pipeline execution</h3>
<p>Now we can describe execution instance and list the steps in the execution to find out more about the execution.</p>
<div class="cell" data-outputid="efe604fa-ddc1-4e23-ad4d-203a0aaadfe2">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>execution_run <span class="op">=</span> execution.describe()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>pprint(execution_run)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'CreatedBy': {'DomainId': 'd-h9yolcap5nrc',
               'UserProfileArn': 'arn:aws:sagemaker:us-east-1:912822595625:user-profile/d-h9yolcap5nrc/sagemaker-user-profile-us-east-1',
               'UserProfileName': 'sagemaker-user-profile-us-east-1'},
 'CreationTime': datetime.datetime(2023, 2, 12, 13, 37, 41, 761000, tzinfo=tzlocal()),
 'LastModifiedBy': {'DomainId': 'd-h9yolcap5nrc',
                    'UserProfileArn': 'arn:aws:sagemaker:us-east-1:912822595625:user-profile/d-h9yolcap5nrc/sagemaker-user-profile-us-east-1',
                    'UserProfileName': 'sagemaker-user-profile-us-east-1'},
 'LastModifiedTime': datetime.datetime(2023, 2, 12, 13, 37, 41, 761000, tzinfo=tzlocal()),
 'PipelineArn': 'arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665',
 'PipelineExecutionArn': 'arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665/execution/h4inlmq7fqwk',
 'PipelineExecutionDisplayName': 'execution-1676209061894',
 'PipelineExecutionStatus': 'Executing',
 'ResponseMetadata': {'HTTPHeaders': {'content-length': '815',
                                      'content-type': 'application/x-amz-json-1.1',
                                      'date': 'Sun, 12 Feb 2023 13:37:46 GMT',
                                      'x-amzn-requestid': '5d8ec01a-6a95-4737-802b-82302f7ab368'},
                      'HTTPStatusCode': 200,
                      'RequestId': '5d8ec01a-6a95-4737-802b-82302f7ab368',
                      'RetryAttempts': 0}}</code></pre>
</div>
</div>
<p>Print the execution display name and its ARN:</p>
<div class="cell" data-outputid="4da59038-01c5-44fb-8b66-b757f6202406">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>execution_run_name <span class="op">=</span> execution_run[<span class="st">'PipelineExecutionDisplayName'</span>]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(execution_run_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>execution-1676209061894</code></pre>
</div>
</div>
<div class="cell" data-outputid="20e767dc-cde1-493c-b769-fd94a2e32c90">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>pipeline_execution_arn <span class="op">=</span> execution_run[<span class="st">'PipelineExecutionArn'</span>]</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pipeline_execution_arn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665/execution/h4inlmq7fqwk</code></pre>
</div>
</div>
</section>
<section id="describe-completed-pipeline" class="level3" data-number="11.4">
<h3 data-number="11.4" class="anchored" data-anchor-id="describe-completed-pipeline"><span class="header-section-number">11.4</span> Describe completed pipeline</h3>
<p>We will wait for the first step to start running and print the information about it:</p>
<div class="cell" data-outputid="c02195a7-bafb-4e5d-a1e6-91b1d30d3723">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">30</span>)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>execution.list_steps()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>[{'StepName': 'Processing',
  'StartTime': datetime.datetime(2023, 2, 12, 13, 37, 42, 570000, tzinfo=tzlocal()),
  'StepStatus': 'Executing',
  'AttemptCount': 0,
  'Metadata': {'ProcessingJob': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:processing-job/pipelines-h4inlmq7fqwk-processing-mwnbfz07z3'}}}]</code></pre>
</div>
</div>
</section>
<section id="wait-for-the-pipeline-to-complete" class="level3" data-number="11.5">
<h3 data-number="11.5" class="anchored" data-anchor-id="wait-for-the-pipeline-to-complete"><span class="header-section-number">11.5</span> Wait for the pipeline to complete</h3>
<p>To get the information about the pipeline execution we can use a low-level service client of the boto3 session. It is also useful for other operations that you will see below.</p>
<p>In the code below we will be observing the pipeline execution summary and waiting for the execution status to change from <code>Executing</code> to <code>Succeeded</code>.</p>
<div class="cell" data-outputid="380b6722-6362-4805-8654-9e398e28f874">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>sm <span class="op">=</span> boto3.Session().client(service_name<span class="op">=</span><span class="st">'sagemaker'</span>, region_name<span class="op">=</span>region)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>executions_response <span class="op">=</span> sm.list_pipeline_executions(PipelineName<span class="op">=</span>pipeline_name)[<span class="st">'PipelineExecutionSummaries'</span>]</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>pipeline_execution_status <span class="op">=</span> executions_response[<span class="dv">0</span>][<span class="st">'PipelineExecutionStatus'</span>]</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pipeline_execution_status)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> pipeline_execution_status<span class="op">==</span><span class="st">'Executing'</span>:</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>        executions_response <span class="op">=</span> sm.list_pipeline_executions(PipelineName<span class="op">=</span>pipeline_name)[<span class="st">'PipelineExecutionSummaries'</span>]</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>        pipeline_execution_status <span class="op">=</span> executions_response[<span class="dv">0</span>][<span class="st">'PipelineExecutionStatus'</span>]</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Please wait...'</span>)</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">30</span>)    </span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>pprint(executions_response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Executing
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
Please wait...
[{'PipelineExecutionArn': 'arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665/execution/h4inlmq7fqwk',
  'PipelineExecutionDisplayName': 'execution-1676209061894',
  'PipelineExecutionStatus': 'Succeeded',
  'StartTime': datetime.datetime(2023, 2, 12, 13, 37, 41, 761000, tzinfo=tzlocal())}]
CPU times: user 14.7 s, sys: 641 ms, total: 15.4 s
Wall time: 32min 38s</code></pre>
</div>
</div>
<p>We can list the execution steps to check out the status and artifacts:</p>
<div class="cell" data-outputid="35bed80d-fa02-4dbf-8dd7-1c049f4f2b14">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>pipeline_execution_status <span class="op">=</span> executions_response[<span class="dv">0</span>][<span class="st">'PipelineExecutionStatus'</span>]</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pipeline_execution_status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Succeeded</code></pre>
</div>
</div>
<div class="cell" data-outputid="ae57cfe1-cc01-4d7f-9509-0a123e8f5fc5">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>pipeline_execution_arn <span class="op">=</span> executions_response[<span class="dv">0</span>][<span class="st">'PipelineExecutionArn'</span>]</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pipeline_execution_arn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:912822595625:pipeline/bert-pipeline-1676208665/execution/h4inlmq7fqwk</code></pre>
</div>
</div>
</section>
</section>
<section id="evaluate-the-model" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="evaluate-the-model"><span class="header-section-number">12</span> Evaluate the model</h2>
<section id="describe-evaluation-metrics" class="level3" data-number="12.1">
<h3 data-number="12.1" class="anchored" data-anchor-id="describe-evaluation-metrics"><span class="header-section-number">12.1</span> Describe evaluation metrics</h3>
<p>Now we examine the resulting model evaluation after the pipeline completes.</p>
<div class="cell" data-outputid="71c01fc4-2b17-4b05-830c-b54ed89c1e7a">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>processing_job_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pull the processing step name</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> <span class="bu">reversed</span>(execution.list_steps()):</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'Processing'</span>:</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        processing_job_name<span class="op">=</span>execution_step[<span class="st">'Metadata'</span>][<span class="st">'ProcessingJob'</span>][<span class="st">'Arn'</span>].split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get the description of the processing job</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>describe_transform_processing_job_response <span class="op">=</span> sm.describe_processing_job(ProcessingJobName<span class="op">=</span>processing_job_name)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get the output S3 path</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>transform_output_s3_uri <span class="op">=</span> describe_transform_processing_job_response[<span class="st">'ProcessingOutputConfig'</span>][<span class="st">'Outputs'</span>][<span class="dv">0</span>][<span class="st">'S3Output'</span>][<span class="st">'S3Uri'</span>]</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Transform output </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(transform_output_s3_uri))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transform output s3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-train</code></pre>
</div>
</div>
<div class="cell" data-outputid="9e51d7c5-bbd5-4397-e79b-4a8112a8674d">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># list the files in the resulting output S3 path</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>aws s3 ls <span class="op">--</span>recursive $transform_output_s3_uri</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2023-02-12 13:48:45    4882265 sagemaker-scikit-learn-2023-02-12-13-32-20-378/output/sentiment-train/part-algo-1-womens_clothing_ecommerce_reviews.tsv</code></pre>
</div>
</div>
<p>Let’s pull the name of the model-evaluation step and then get the S3 path of the evaluation metrics, which will contain the evaluation report.</p>
<div class="cell" data-outputid="89be571d-1417-4fff-ed89-7429df045686">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>processing_job_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> <span class="bu">reversed</span>(execution.list_steps()):</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'EvaluateModel'</span>: </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>        processing_job_name<span class="op">=</span>execution_step[<span class="st">'Metadata'</span>][<span class="st">'ProcessingJob'</span>][<span class="st">'Arn'</span>].split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>describe_evaluation_processing_job_response <span class="op">=</span> sm.describe_processing_job(ProcessingJobName<span class="op">=</span>processing_job_name)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>evaluation_metrics_s3_uri <span class="op">=</span> describe_evaluation_processing_job_response[<span class="st">'ProcessingOutputConfig'</span>][<span class="st">'Outputs'</span>][<span class="dv">0</span>][<span class="st">'S3Output'</span>][<span class="st">'S3Uri'</span>]</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Evaluation output </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(evaluation_metrics_s3_uri))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Evaluation output s3://sagemaker-us-east-1-912822595625/sagemaker-scikit-learn-2023-02-12-13-35-32-414/output/metrics</code></pre>
</div>
</div>
</section>
<section id="review-the-evaluation-report" class="level3" data-number="12.2">
<h3 data-number="12.2" class="anchored" data-anchor-id="review-the-evaluation-report"><span class="header-section-number">12.2</span> Review the evaluation report</h3>
<p>Download the evaluation report and print the accuracy.</p>
<div class="cell" data-outputid="7b1c79b8-2c63-4392-d604-57888208403b">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pprint</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>evaluation_json <span class="op">=</span> sagemaker.s3.S3Downloader.read_file(<span class="st">"</span><span class="sc">{}</span><span class="st">/evaluation.json"</span>.<span class="bu">format</span>(</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    evaluation_metrics_s3_uri</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>pprint(json.loads(evaluation_json))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'metrics': {'accuracy': {'value': 0.7313915857605178}}}</code></pre>
</div>
</div>
</section>
<section id="list-pipeline-artifacts" class="level3" data-number="12.3">
<h3 data-number="12.3" class="anchored" data-anchor-id="list-pipeline-artifacts"><span class="header-section-number">12.3</span> List pipeline artifacts</h3>
<p>Now let’s find and print the ARN and job name of the training job.</p>
<div class="cell" data-outputid="7ab73b20-8c68-4d38-b603-d2bea3a64094">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>training_job_arn<span class="op">=</span><span class="va">None</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> execution.list_steps():</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'Train'</span>:</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>        training_job_arn <span class="op">=</span> execution_step[<span class="st">'Metadata'</span>][<span class="st">'TrainingJob'</span>][<span class="st">'Arn'</span>]        </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>        pprint(execution_step)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Training job ARN: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(training_job_arn))</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>training_job_name <span class="op">=</span> training_job_arn.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Training job Name: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(training_job_name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 4, 49, 838000, tzinfo=tzlocal()),
 'Metadata': {'TrainingJob': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:training-job/pipelines-h4inlmq7fqwk-Train-nYXyWGwBe5'}},
 'StartTime': datetime.datetime(2023, 2, 12, 13, 48, 54, 641000, tzinfo=tzlocal()),
 'StepName': 'Train',
 'StepStatus': 'Succeeded'}
Training job ARN: arn:aws:sagemaker:us-east-1:912822595625:training-job/pipelines-h4inlmq7fqwk-Train-nYXyWGwBe5
Training job Name: pipelines-h4inlmq7fqwk-Train-nYXyWGwBe5</code></pre>
</div>
</div>
<p>Using similar approach we can find and print the pipeline artifacts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>processing_job_name<span class="op">=</span><span class="va">None</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>training_job_name<span class="op">=</span><span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="0cf68005-c1d1-4277-9e23-ea043e62f970">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.lineage.visualizer <span class="im">import</span> LineageTableVisualizer</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>viz <span class="op">=</span> LineageTableVisualizer(sagemaker.session.Session())</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> <span class="bu">reversed</span>(execution.list_steps()):</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    pprint(execution_step)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'Processing'</span>:</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>        processing_job_name<span class="op">=</span>execution_step[<span class="st">'Metadata'</span>][<span class="st">'ProcessingJob'</span>][<span class="st">'Arn'</span>].split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Processing job name: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(processing_job_name))</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>        display(viz.show(processing_job_name<span class="op">=</span>processing_job_name))</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'Train'</span>:</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>        training_job_name<span class="op">=</span>execution_step[<span class="st">'Metadata'</span>][<span class="st">'TrainingJob'</span>][<span class="st">'Arn'</span>].split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Training job name: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(training_job_name))</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>        display(viz.show(training_job_name<span class="op">=</span>training_job_name))</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>        display(viz.show(pipeline_execution_step<span class="op">=</span>execution_step))</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 13, 48, 53, 920000, tzinfo=tzlocal()),
 'Metadata': {'ProcessingJob': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:processing-job/pipelines-h4inlmq7fqwk-processing-mwnbfz07z3'}},
 'StartTime': datetime.datetime(2023, 2, 12, 13, 37, 42, 570000, tzinfo=tzlocal()),
 'StepName': 'Processing',
 'StepStatus': 'Succeeded'}
Processing job name: pipelines-h4inlmq7fqwk-processing-mwnbfz07z3</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Name/Source</th>
      <th>Direction</th>
      <th>Type</th>
      <th>Association Type</th>
      <th>Lineage Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>s3://...-13-37-36-257/input/code/prepare_data.py</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>1</th>
      <td>s3://dlai-practical-data-science/data/raw/</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>2</th>
      <td>68331...om/sagemaker-scikit-learn:0.23-1-cpu-py3</td>
      <td>Input</td>
      <td>Image</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>3</th>
      <td>s3://...02-12-13-32-20-378/output/sentiment-test</td>
      <td>Output</td>
      <td>DataSet</td>
      <td>Produced</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>4</th>
      <td>s3://...13-32-20-378/output/sentiment-validation</td>
      <td>Output</td>
      <td>DataSet</td>
      <td>Produced</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>5</th>
      <td>s3://...2-12-13-32-20-378/output/sentiment-train</td>
      <td>Output</td>
      <td>DataSet</td>
      <td>Produced</td>
      <td>artifact</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 4, 49, 838000, tzinfo=tzlocal()),
 'Metadata': {'TrainingJob': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:training-job/pipelines-h4inlmq7fqwk-Train-nYXyWGwBe5'}},
 'StartTime': datetime.datetime(2023, 2, 12, 13, 48, 54, 641000, tzinfo=tzlocal()),
 'StepName': 'Train',
 'StepStatus': 'Succeeded'}
Training job name: pipelines-h4inlmq7fqwk-Train-nYXyWGwBe5</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Name/Source</th>
      <th>Direction</th>
      <th>Type</th>
      <th>Association Type</th>
      <th>Lineage Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>s3://...13-32-20-378/output/sentiment-validation</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>1</th>
      <td>s3://...2-12-13-32-20-378/output/sentiment-train</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>2</th>
      <td>76310...onaws.com/pytorch-training:1.6.0-cpu-py3</td>
      <td>Input</td>
      <td>Image</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>3</th>
      <td>s3://...qwk-Train-nYXyWGwBe5/output/model.tar.gz</td>
      <td>Output</td>
      <td>Model</td>
      <td>Produced</td>
      <td>artifact</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 10, 48, 729000, tzinfo=tzlocal()),
 'Metadata': {'ProcessingJob': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:processing-job/pipelines-h4inlmq7fqwk-evaluatemodel-uqvunnu2ks'}},
 'StartTime': datetime.datetime(2023, 2, 12, 14, 4, 50, 615000, tzinfo=tzlocal()),
 'StepName': 'EvaluateModel',
 'StepStatus': 'Succeeded'}</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Name/Source</th>
      <th>Direction</th>
      <th>Type</th>
      <th>Association Type</th>
      <th>Lineage Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>s3://...640/input/code/evaluate_model_metrics.py</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>1</th>
      <td>s3://...02-12-13-32-20-378/output/sentiment-test</td>
      <td>Input</td>
      <td>DataSet</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>2</th>
      <td>s3://...qwk-Train-nYXyWGwBe5/output/model.tar.gz</td>
      <td>Input</td>
      <td>Model</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>3</th>
      <td>68331...om/sagemaker-scikit-learn:0.23-1-cpu-py3</td>
      <td>Input</td>
      <td>Image</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>4</th>
      <td>s3://...n-2023-02-12-13-35-32-414/output/metrics</td>
      <td>Output</td>
      <td>DataSet</td>
      <td>Produced</td>
      <td>artifact</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 10, 50, 320000, tzinfo=tzlocal()),
 'Metadata': {'Condition': {'Outcome': 'True'}},
 'StartTime': datetime.datetime(2023, 2, 12, 14, 10, 49, 585000, tzinfo=tzlocal()),
 'StepName': 'AccuracyCondition',
 'StepStatus': 'Succeeded'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 10, 52, 545000, tzinfo=tzlocal()),
 'Metadata': {'Model': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:model/pipelines-h4inlmq7fqwk-createmodel-tu0lobcfq6'}},
 'StartTime': datetime.datetime(2023, 2, 12, 14, 10, 51, 78000, tzinfo=tzlocal()),
 'StepName': 'CreateModel',
 'StepStatus': 'Succeeded'}</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>None</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'AttemptCount': 0,
 'EndTime': datetime.datetime(2023, 2, 12, 14, 10, 52, 324000, tzinfo=tzlocal()),
 'Metadata': {'RegisterModel': {'Arn': 'arn:aws:sagemaker:us-east-1:912822595625:model-package/bert-reviews-1676208665/1'}},
 'StartTime': datetime.datetime(2023, 2, 12, 14, 10, 51, 78000, tzinfo=tzlocal()),
 'StepName': 'RegisterModel',
 'StepStatus': 'Succeeded'}</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Name/Source</th>
      <th>Direction</th>
      <th>Type</th>
      <th>Association Type</th>
      <th>Lineage Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>s3://...qwk-Train-nYXyWGwBe5/output/model.tar.gz</td>
      <td>Input</td>
      <td>Model</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>1</th>
      <td>76310...aws.com/pytorch-inference:1.6.0-cpu-py36</td>
      <td>Input</td>
      <td>Image</td>
      <td>ContributedTo</td>
      <td>artifact</td>
    </tr>
    <tr>
      <th>2</th>
      <td>bert-reviews-1676208665-1-PendingManualApprova...</td>
      <td>Input</td>
      <td>Approval</td>
      <td>ContributedTo</td>
      <td>action</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BERT-Reviews-1676208665-1676211052-aws-model-p...</td>
      <td>Output</td>
      <td>ModelGroup</td>
      <td>AssociatedWith</td>
      <td>context</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
</section>
<section id="deploy-and-test-the-model" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="deploy-and-test-the-model"><span class="header-section-number">13</span> Deploy and test the model</h2>
<section id="approve-trained-model" class="level3" data-number="13.1">
<h3 data-number="13.1" class="anchored" data-anchor-id="approve-trained-model"><span class="header-section-number">13.1</span> Approve trained model</h3>
<p>The pipeline created a model package version within the specified model package group and an approval status of <code>PendingManualApproval</code>. This requires a separate step to manually approve the model before deploying to production.</p>
<p>We can approve the model using the SageMaker Studio UI or programmatically as shown below.</p>
<p>Get the model package ARN.</p>
<div class="cell" data-outputid="b5a1f02f-625f-43b6-9c17-18972e1ca6b1">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> execution.list_steps():</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'RegisterModel'</span>:</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>        model_package_arn <span class="op">=</span> execution_step[<span class="st">'Metadata'</span>][<span class="st">'RegisterModel'</span>][<span class="st">'Arn'</span>]</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_package_arn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>arn:aws:sagemaker:us-east-1:912822595625:model-package/bert-reviews-1676208665/1</code></pre>
</div>
</div>
<p>Update the model package with the <code>Approved</code> status to prepare for deployment.</p>
<p>The model must be <code>Approved</code> before it can be deployed.</p>
<div class="cell" data-outputid="49ae389d-3b0b-4529-b77c-09f035f94b9c">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>model_package_update_response <span class="op">=</span> sm.update_model_package(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    ModelPackageArn<span class="op">=</span>model_package_arn,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    ModelApprovalStatus<span class="op">=</span><span class="st">"Approved"</span>,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>pprint(model_package_update_response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'ModelPackageArn': 'arn:aws:sagemaker:us-east-1:912822595625:model-package/bert-reviews-1676208665/1',
 'ResponseMetadata': {'HTTPHeaders': {'content-length': '102',
                                      'content-type': 'application/x-amz-json-1.1',
                                      'date': 'Sun, 12 Feb 2023 14:15:24 GMT',
                                      'x-amzn-requestid': '95e70fcf-b3f0-4925-be40-73450c40a5ec'},
                      'HTTPStatusCode': 200,
                      'RequestId': '95e70fcf-b3f0-4925-be40-73450c40a5ec',
                      'RetryAttempts': 0}}</code></pre>
</div>
</div>
</section>
<section id="deploy-model" class="level3" data-number="13.2">
<h3 data-number="13.2" class="anchored" data-anchor-id="deploy-model"><span class="header-section-number">13.2</span> Deploy model</h3>
<p>Get the model ARN and the model name from it.</p>
<div class="cell" data-outputid="4a79b3a9-63ca-4182-dfed-063d0827cb1b">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> execution_step <span class="kw">in</span> execution.list_steps():</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(execution_step[<span class="st">'StepName'</span>])</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> execution_step[<span class="st">'StepName'</span>] <span class="op">==</span> <span class="st">'CreateModel'</span>:</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>        model_arn <span class="op">=</span> execution_step[<span class="st">'Metadata'</span>][<span class="st">'Model'</span>][<span class="st">'Arn'</span>]</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_arn)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>model_name <span class="op">=</span> model_arn.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RegisterModel
CreateModel
arn:aws:sagemaker:us-east-1:912822595625:model/pipelines-h4inlmq7fqwk-createmodel-tu0lobcfq6
pipelines-h4inlmq7fqwk-createmodel-tu0lobcfq6</code></pre>
</div>
</div>
</section>
<section id="create-endpoint-from-registry" class="level3" data-number="13.3">
<h3 data-number="13.3" class="anchored" data-anchor-id="create-endpoint-from-registry"><span class="header-section-number">13.3</span> Create endpoint from registry</h3>
<p>Configure the endpoint.</p>
<div class="cell" data-outputid="8d65d1cc-8ed2-4682-8eae-52ad417070e9">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>endpoint_config_name <span class="op">=</span> <span class="st">'bert-model-epc-</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(timestamp)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(endpoint_config_name)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>create_endpoint_config_response <span class="op">=</span> sm.create_endpoint_config(</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    EndpointConfigName <span class="op">=</span> endpoint_config_name,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    ProductionVariants<span class="op">=</span>[{</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'InstanceType'</span>:<span class="st">'ml.m5.xlarge'</span>,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'InitialVariantWeight'</span>:<span class="dv">1</span>,</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'InitialInstanceCount'</span>:<span class="dv">1</span>,</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ModelName'</span>: model_name,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VariantName'</span>:<span class="st">'AllTraffic'</span>}])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bert-model-epc-1676208665</code></pre>
</div>
</div>
<p>Create the endpoint.</p>
<div class="cell" data-outputid="8e6c05ae-6a88-4e71-fc09-307995983c70">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>pipeline_endpoint_name <span class="op">=</span> <span class="st">'bert-model-ep-</span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(timestamp)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"EndpointName=</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(pipeline_endpoint_name))</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>create_endpoint_response <span class="op">=</span> sm.create_endpoint(</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    EndpointName<span class="op">=</span>pipeline_endpoint_name,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    EndpointConfigName<span class="op">=</span>endpoint_config_name)</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(create_endpoint_response[<span class="st">'EndpointArn'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EndpointName=bert-model-ep-1676208665
arn:aws:sagemaker:us-east-1:912822595625:endpoint/bert-model-ep-1676208665</code></pre>
</div>
</div>
<div class="cell" data-outputid="816fc01f-bff8-404c-fe80-f4d416405b6a">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>: </span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        waiter <span class="op">=</span> sm.get_waiter(<span class="st">'endpoint_in_service'</span>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Waiting for endpoint to be in `InService`...'</span>)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>        waiter.wait(EndpointName<span class="op">=</span>pipeline_endpoint_name)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Waiting for endpoint...'</span>)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>        endpoint_status <span class="op">=</span> sm.describe_endpoint(EndpointName<span class="op">=</span>pipeline_endpoint_name)[<span class="st">'EndpointStatus'</span>]</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'Endpoint status: </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(endpoint_status))</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> endpoint_status <span class="op">==</span> <span class="st">'Failed'</span>:</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">30</span>)</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Endpoint deployed.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Waiting for endpoint to be in `InService`...
Endpoint deployed.
CPU times: user 109 ms, sys: 30.6 ms, total: 140 ms
Wall time: 4min 31s</code></pre>
</div>
</div>
</section>
<section id="test-model" class="level3" data-number="13.4">
<h3 data-number="13.4" class="anchored" data-anchor-id="test-model"><span class="header-section-number">13.4</span> Test model</h3>
<p>Let’s predict the <code>sentiment</code> with <code>review_body</code> samples and review the result:</p>
<div class="cell" data-outputid="09f68f38-d201-44c0-a111-5ff2b2b7da19">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.predictor <span class="im">import</span> Predictor</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.serializers <span class="im">import</span> JSONLinesSerializer</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sagemaker.deserializers <span class="im">import</span> JSONLinesDeserializer</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> [</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"features"</span>: [<span class="st">"I love this product!"</span>]},</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"features"</span>: [<span class="st">"OK, but not great."</span>]},</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"features"</span>: [<span class="st">"This is not the right product."</span>]},</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>predictor <span class="op">=</span> Predictor(</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    endpoint_name<span class="op">=</span>pipeline_endpoint_name,</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    serializer<span class="op">=</span>JSONLinesSerializer(),</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    deserializer<span class="op">=</span>JSONLinesDeserializer(),</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    sagemaker_session<span class="op">=</span>sess</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>predicted_classes <span class="op">=</span> predictor.predict(inputs)</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> predicted_class <span class="kw">in</span> predicted_classes:</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Predicted class </span><span class="sc">{}</span><span class="st"> with probability </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(predicted_class[<span class="st">'predicted_label'</span>], predicted_class[<span class="st">'probability'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predicted class 1 with probability 0.9203698635101318
Predicted class 0 with probability 0.44024962186813354
Predicted class -1 with probability 0.778016209602356</code></pre>
</div>
</div>
</section>
<section id="sagemaker-studio-extensions" class="level3" data-number="13.5">
<h3 data-number="13.5" class="anchored" data-anchor-id="sagemaker-studio-extensions"><span class="header-section-number">13.5</span> SageMaker Studio extensions</h3>
<p>SageMaker Studio provides a rich set of features to visually inspect SageMaker resources including pipelines, training jobs, and endpoints.</p>
<p><img src="https://github.com/pranath/blog/raw/master/images/sm_studio_extensions_pipelines.png" title="Sagemaker Studio Extensions" class="img-fluid"></p>
</section>
</section>
<section id="acknowledgements" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="acknowledgements"><span class="header-section-number">14</span> Acknowledgements</h2>
<p>I’d like to express my thanks to the great <a href="https://www.deeplearning.ai/courses/practical-data-science-specialization/">Deep Learning AI Practical Data Science on AWS Specialisation Course</a> which i completed, and acknowledge the use of some images and other materials from the training course in this article.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>