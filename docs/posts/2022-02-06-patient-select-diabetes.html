<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pranath Fernando">
<meta name="dcterms.date" content="2022-02-06">
<meta name="description" content="Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.">

<title>LivingDataLab - Patient Selection for Diabetes Drug Testing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-91568149-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>


<link rel="stylesheet" href="../css/styles.css">
<meta property="og:title" content="LivingDataLab - Patient Selection for Diabetes Drug Testing">
<meta property="og:description" content="Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.">
<meta property="og:image" content="https://github.com/pranath/blog/raw/master/images/artificial-intelligence-medical.jpg">
<meta property="og:site-name" content="LivingDataLab">
<meta name="twitter:title" content="LivingDataLab - Patient Selection for Diabetes Drug Testing">
<meta name="twitter:description" content="Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.">
<meta name="twitter:image" content="https://github.com/pranath/blog/raw/master/images/artificial-intelligence-medical.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">LivingDataLab</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://thefuturai.substack.com/" rel="" target=""><i class="bi bi-substack" role="img">
</i> 
 <span class="menu-text">Newsletter</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../projects.html" rel="" target="" aria-current="page">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/pranath-fernando/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/LivingDataLab" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pranath" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Patient Selection for Diabetes Drug Testing</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Patient Selection for Diabetes Drug Testing</h1>
                  <div>
        <div class="description">
          Utilizing a synthetic Diabetes patient dataset, we will create a deep learning model trained on EHR data (Electronic Health Records) to find suitable patients for testing a new Diabetes drug.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">health</div>
                <div class="quarto-category">deep-learning</div>
                <div class="quarto-category">electronic-health-records</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Pranath Fernando </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 6, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Projects Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/doc-chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Document Chat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/doc-summarisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Document Summarisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/web-page-chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Web Page Chat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/web-page-summarisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Web Page Summarisation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/youtube-chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">YouTube Chat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/youtube-summarisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">YouTube Summarisation</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<!-- Begin Mailchimp Signup Form -->
<a href="https://thefuturai.substack.com/"><h2>Subscribe</h2></a>
<!--End mc_embed_signup-->

</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#approach" id="toc-approach" class="nav-link" data-scroll-target="#approach"><span class="header-section-number">2</span> Approach</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">3</span> Dataset</a></li>
  <li><a href="#dataset-loading-and-schema-review" id="toc-dataset-loading-and-schema-review" class="nav-link" data-scroll-target="#dataset-loading-and-schema-review"><span class="header-section-number">4</span> Dataset Loading and Schema Review</a>
  <ul class="collapse">
  <li><a href="#determine-level-of-dataset-line-or-encounter" id="toc-determine-level-of-dataset-line-or-encounter" class="nav-link" data-scroll-target="#determine-level-of-dataset-line-or-encounter"><span class="header-section-number">4.1</span> Determine Level of Dataset (Line or Encounter)</a></li>
  </ul></li>
  <li><a href="#analyze-dataset" id="toc-analyze-dataset" class="nav-link" data-scroll-target="#analyze-dataset"><span class="header-section-number">5</span> Analyze Dataset</a>
  <ul class="collapse">
  <li><a href="#analysis-key-findings" id="toc-analysis-key-findings" class="nav-link" data-scroll-target="#analysis-key-findings"><span class="header-section-number">5.1</span> Analysis key findings</a></li>
  </ul></li>
  <li><a href="#reduce-dimensionality-of-the-ndc-code-feature" id="toc-reduce-dimensionality-of-the-ndc-code-feature" class="nav-link" data-scroll-target="#reduce-dimensionality-of-the-ndc-code-feature"><span class="header-section-number">6</span> Reduce Dimensionality of the NDC Code Feature</a></li>
  <li><a href="#select-first-encounter-for-each-patient" id="toc-select-first-encounter-for-each-patient" class="nav-link" data-scroll-target="#select-first-encounter-for-each-patient"><span class="header-section-number">7</span> Select First Encounter for each Patient</a></li>
  <li><a href="#aggregate-dataset-to-right-level-for-modelling" id="toc-aggregate-dataset-to-right-level-for-modelling" class="nav-link" data-scroll-target="#aggregate-dataset-to-right-level-for-modelling"><span class="header-section-number">8</span> Aggregate Dataset to Right Level for Modelling</a></li>
  <li><a href="#prepare-fields-and-cast-dataset" id="toc-prepare-fields-and-cast-dataset" class="nav-link" data-scroll-target="#prepare-fields-and-cast-dataset"><span class="header-section-number">9</span> Prepare Fields and Cast Dataset</a>
  <ul class="collapse">
  <li><a href="#feature-selection" id="toc-feature-selection" class="nav-link" data-scroll-target="#feature-selection"><span class="header-section-number">9.1</span> Feature Selection</a></li>
  <li><a href="#preprocess-dataset---casting-and-imputing" id="toc-preprocess-dataset---casting-and-imputing" class="nav-link" data-scroll-target="#preprocess-dataset---casting-and-imputing"><span class="header-section-number">9.2</span> Preprocess Dataset - Casting and Imputing</a></li>
  </ul></li>
  <li><a href="#split-dataset-into-train-validation-and-test-partitions" id="toc-split-dataset-into-train-validation-and-test-partitions" class="nav-link" data-scroll-target="#split-dataset-into-train-validation-and-test-partitions"><span class="header-section-number">10</span> Split Dataset into Train, Validation, and Test Partitions</a></li>
  <li><a href="#demographic-representation-analysis-of-split" id="toc-demographic-representation-analysis-of-split" class="nav-link" data-scroll-target="#demographic-representation-analysis-of-split"><span class="header-section-number">11</span> Demographic Representation Analysis of Split</a>
  <ul class="collapse">
  <li><a href="#label-distribution-across-partitions" id="toc-label-distribution-across-partitions" class="nav-link" data-scroll-target="#label-distribution-across-partitions"><span class="header-section-number">11.1</span> Label Distribution Across Partitions</a></li>
  <li><a href="#demographic-group-analysis" id="toc-demographic-group-analysis" class="nav-link" data-scroll-target="#demographic-group-analysis"><span class="header-section-number">11.2</span> Demographic Group Analysis</a></li>
  </ul></li>
  <li><a href="#convert-dataset-splits-to-tf-dataset" id="toc-convert-dataset-splits-to-tf-dataset" class="nav-link" data-scroll-target="#convert-dataset-splits-to-tf-dataset"><span class="header-section-number">12</span> Convert Dataset Splits to TF Dataset</a></li>
  <li><a href="#create-features" id="toc-create-features" class="nav-link" data-scroll-target="#create-features"><span class="header-section-number">13</span> Create Features</a>
  <ul class="collapse">
  <li><a href="#create-categorical-features-with-tf-feature-columns" id="toc-create-categorical-features-with-tf-feature-columns" class="nav-link" data-scroll-target="#create-categorical-features-with-tf-feature-columns"><span class="header-section-number">13.1</span> Create Categorical Features with TF Feature Columns</a></li>
  <li><a href="#create-categorical-features-with-tensorflow-feature-column-api" id="toc-create-categorical-features-with-tensorflow-feature-column-api" class="nav-link" data-scroll-target="#create-categorical-features-with-tensorflow-feature-column-api"><span class="header-section-number">13.2</span> Create Categorical Features with Tensorflow Feature Column API</a></li>
  <li><a href="#create-numerical-features-with-tf-feature-columns" id="toc-create-numerical-features-with-tf-feature-columns" class="nav-link" data-scroll-target="#create-numerical-features-with-tf-feature-columns"><span class="header-section-number">13.3</span> Create Numerical Features with TF Feature Columns</a></li>
  </ul></li>
  <li><a href="#build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers" id="toc-build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers" class="nav-link" data-scroll-target="#build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers"><span class="header-section-number">14</span> Build Deep Learning Regression Model with Sequential API and TF Probability Layers</a>
  <ul class="collapse">
  <li><a href="#use-densefeatures-to-combine-features-for-model" id="toc-use-densefeatures-to-combine-features-for-model" class="nav-link" data-scroll-target="#use-densefeatures-to-combine-features-for-model"><span class="header-section-number">14.1</span> Use DenseFeatures to combine features for model</a></li>
  <li><a href="#build-sequential-api-model-from-densefeatures-and-tf-probability-layers" id="toc-build-sequential-api-model-from-densefeatures-and-tf-probability-layers" class="nav-link" data-scroll-target="#build-sequential-api-model-from-densefeatures-and-tf-probability-layers"><span class="header-section-number">14.2</span> Build Sequential API Model from DenseFeatures and TF Probability Layers</a></li>
  <li><a href="#show-model-uncertainty-range-with-tf-probability" id="toc-show-model-uncertainty-range-with-tf-probability" class="nav-link" data-scroll-target="#show-model-uncertainty-range-with-tf-probability"><span class="header-section-number">14.3</span> Show Model Uncertainty Range with TF Probability</a></li>
  <li><a href="#show-prediction-output" id="toc-show-prediction-output" class="nav-link" data-scroll-target="#show-prediction-output"><span class="header-section-number">14.4</span> Show Prediction Output</a></li>
  <li><a href="#convert-regression-output-to-classification-output-for-patient-selection" id="toc-convert-regression-output-to-classification-output-for-patient-selection" class="nav-link" data-scroll-target="#convert-regression-output-to-classification-output-for-patient-selection"><span class="header-section-number">14.5</span> Convert Regression Output to Classification Output for Patient Selection</a></li>
  <li><a href="#add-binary-prediction-to-test-dataframe" id="toc-add-binary-prediction-to-test-dataframe" class="nav-link" data-scroll-target="#add-binary-prediction-to-test-dataframe"><span class="header-section-number">14.6</span> Add Binary Prediction to Test Dataframe</a></li>
  </ul></li>
  <li><a href="#model-evaluation-metrics" id="toc-model-evaluation-metrics" class="nav-link" data-scroll-target="#model-evaluation-metrics"><span class="header-section-number">15</span> Model Evaluation Metrics</a></li>
  <li><a href="#evaluating-potential-model-biases-with-aequitas-toolkit" id="toc-evaluating-potential-model-biases-with-aequitas-toolkit" class="nav-link" data-scroll-target="#evaluating-potential-model-biases-with-aequitas-toolkit"><span class="header-section-number">16</span> Evaluating Potential Model Biases with Aequitas Toolkit</a>
  <ul class="collapse">
  <li><a href="#prepare-data-for-aequitas-bias-toolkit" id="toc-prepare-data-for-aequitas-bias-toolkit" class="nav-link" data-scroll-target="#prepare-data-for-aequitas-bias-toolkit"><span class="header-section-number">16.1</span> Prepare Data For Aequitas Bias Toolkit</a></li>
  <li><a href="#reference-group-selection" id="toc-reference-group-selection" class="nav-link" data-scroll-target="#reference-group-selection"><span class="header-section-number">16.2</span> Reference Group Selection</a></li>
  <li><a href="#race-and-gender-bias-analysis-for-patient-selection" id="toc-race-and-gender-bias-analysis-for-patient-selection" class="nav-link" data-scroll-target="#race-and-gender-bias-analysis-for-patient-selection"><span class="header-section-number">16.3</span> Race and Gender Bias Analysis for Patient Selection</a></li>
  <li><a href="#fairness-analysis-example---relative-to-a-reference-group" id="toc-fairness-analysis-example---relative-to-a-reference-group" class="nav-link" data-scroll-target="#fairness-analysis-example---relative-to-a-reference-group"><span class="header-section-number">16.4</span> Fairness Analysis Example - Relative to a Reference Group</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>EHR data is becoming a key source of real-world evidence (RWE) for the pharmaceutical industry and regulators to <a href="https://www.fda.gov/news-events/speeches-fda-officials/breaking-down-barriers-between-clinical-trials-and-clinical-care-incorporating-real-world-evidence">make decisions on clinical trials</a>.</p>
<p>For this project, we have a groundbreaking diabetes drug that is ready for clinical trial testing. It is a very unique and sensitive drug that requires administering the drug over at least 5-7 days of time in the hospital with frequent monitoring/testing and patient medication adherence training with a mobile application. We have been provided a patient dataset from a client partner and are tasked with building a predictive model that can identify which type of patients the company should focus their efforts testing this drug on. Target patients are people that are likely to be in the hospital for this duration of time and will not incur significant additional costs for administering this drug to the patient and monitoring.</p>
<p>In order to achieve our goal we must build a regression model that can predict the estimated hospitalization time for a patient and use this to select/filter patients for this study.</p>
</section>
<section id="approach" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="approach"><span class="header-section-number">2</span> Approach</h2>
<p>Utilizing a synthetic dataset (denormalized at the line level augmentation) built off of the UCI Diabetes readmission dataset, we will build a regression model that predicts the expected days of hospitalization time and then convert this to a binary prediction of whether to include or exclude that patient from the clinical trial.</p>
<p>This project will demonstrate the importance of building the right data representation at the encounter level, with appropriate filtering and preprocessing/feature engineering of key medical code sets. We will also analyze and interpret the model for biases across key demographic groups.</p>
</section>
<section id="dataset" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="dataset"><span class="header-section-number">3</span> Dataset</h2>
<p>Due to healthcare PHI regulations (HIPAA, HITECH), there are limited number of publicly available datasets and some datasets require training and approval. So, for the purpose of this study, we are using a dataset from <a href="https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008">UC Irvine</a> that has been modified.</p>
</section>
<section id="dataset-loading-and-schema-review" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="dataset-loading-and-schema-review"><span class="header-section-number">4</span> Dataset Loading and Schema Review</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dataset_path <span class="op">=</span> <span class="st">"./data/final_project_dataset.csv"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(dataset_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show first few rows</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
encounter_id
</th>
<th>
patient_nbr
</th>
<th>
race
</th>
<th>
gender
</th>
<th>
age
</th>
<th>
weight
</th>
<th>
admission_type_id
</th>
<th>
discharge_disposition_id
</th>
<th>
admission_source_id
</th>
<th>
time_in_hospital
</th>
<th>
payer_code
</th>
<th>
medical_specialty
</th>
<th>
primary_diagnosis_code
</th>
<th>
other_diagnosis_codes
</th>
<th>
number_outpatient
</th>
<th>
number_inpatient
</th>
<th>
number_emergency
</th>
<th>
num_lab_procedures
</th>
<th>
number_diagnoses
</th>
<th>
num_medications
</th>
<th>
num_procedures
</th>
<th>
ndc_code
</th>
<th>
max_glu_serum
</th>
<th>
A1Cresult
</th>
<th>
change
</th>
<th>
readmitted
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
2278392
</td>
<td>
8222157
</td>
<td>
Caucasian
</td>
<td>
Female
</td>
<td>
[0-10)
</td>
<td>
?
</td>
<td>
6
</td>
<td>
25
</td>
<td>
1
</td>
<td>
1
</td>
<td>
?
</td>
<td>
Pediatrics-Endocrinology
</td>
<td>
250.83
</td>
<td>
?|?
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
41
</td>
<td>
1
</td>
<td>
1
</td>
<td>
0
</td>
<td>
NaN
</td>
<td>
None
</td>
<td>
None
</td>
<td>
No
</td>
<td>
NO
</td>
</tr>
<tr>
<th>
1
</th>
<td>
149190
</td>
<td>
55629189
</td>
<td>
Caucasian
</td>
<td>
Female
</td>
<td>
[10-20)
</td>
<td>
?
</td>
<td>
1
</td>
<td>
1
</td>
<td>
7
</td>
<td>
3
</td>
<td>
?
</td>
<td>
?
</td>
<td>
276
</td>
<td>
250.01|255
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
59
</td>
<td>
9
</td>
<td>
18
</td>
<td>
0
</td>
<td>
68071-1701
</td>
<td>
None
</td>
<td>
None
</td>
<td>
Ch
</td>
<td>
&gt;30
</td>
</tr>
<tr>
<th>
2
</th>
<td>
64410
</td>
<td>
86047875
</td>
<td>
AfricanAmerican
</td>
<td>
Female
</td>
<td>
[20-30)
</td>
<td>
?
</td>
<td>
1
</td>
<td>
1
</td>
<td>
7
</td>
<td>
2
</td>
<td>
?
</td>
<td>
?
</td>
<td>
648
</td>
<td>
250|V27
</td>
<td>
2
</td>
<td>
1
</td>
<td>
0
</td>
<td>
11
</td>
<td>
6
</td>
<td>
13
</td>
<td>
5
</td>
<td>
0378-1110
</td>
<td>
None
</td>
<td>
None
</td>
<td>
No
</td>
<td>
NO
</td>
</tr>
<tr>
<th>
3
</th>
<td>
500364
</td>
<td>
82442376
</td>
<td>
Caucasian
</td>
<td>
Male
</td>
<td>
[30-40)
</td>
<td>
?
</td>
<td>
1
</td>
<td>
1
</td>
<td>
7
</td>
<td>
2
</td>
<td>
?
</td>
<td>
?
</td>
<td>
8
</td>
<td>
250.43|403
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
44
</td>
<td>
7
</td>
<td>
16
</td>
<td>
1
</td>
<td>
68071-1701
</td>
<td>
None
</td>
<td>
None
</td>
<td>
Ch
</td>
<td>
NO
</td>
</tr>
<tr>
<th>
4
</th>
<td>
16680
</td>
<td>
42519267
</td>
<td>
Caucasian
</td>
<td>
Male
</td>
<td>
[40-50)
</td>
<td>
?
</td>
<td>
1
</td>
<td>
1
</td>
<td>
7
</td>
<td>
1
</td>
<td>
?
</td>
<td>
?
</td>
<td>
197
</td>
<td>
157|250
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
51
</td>
<td>
5
</td>
<td>
8
</td>
<td>
0
</td>
<td>
0049-4110
</td>
<td>
None
</td>
<td>
None
</td>
<td>
Ch
</td>
<td>
NO
</td>
</tr>
</tbody>

</table>
</div>
<section id="determine-level-of-dataset-line-or-encounter" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="determine-level-of-dataset-line-or-encounter"><span class="header-section-number">4.1</span> Determine Level of Dataset (Line or Encounter)</h3>
<p>Given there are only 101766 unique encounter_id’s yet there are 143424 rows that are not nulls, this looks like the dataset is at the line level.</p>
<p>We would also want to aggregate on the primary_diagnosis_code as there is also only one of these per encounter. By aggregating on these 3 columns, we can create a encounter level dataset.</p>
</section>
</section>
<section id="analyze-dataset" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="analyze-dataset"><span class="header-section-number">5</span> Analyze Dataset</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at range of values &amp; key stats for numerical columns</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>numerical_feature_list <span class="op">=</span> [<span class="st">'time_in_hospital'</span>,  <span class="st">'number_outpatient'</span>, <span class="st">'number_inpatient'</span>, <span class="st">'number_emergency'</span>, <span class="st">'num_lab_procedures'</span>, <span class="st">'number_diagnoses'</span>, <span class="st">'num_medications'</span>, <span class="st">'num_procedures'</span> ]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df[numerical_feature_list].describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
time_in_hospital
</th>
<th>
number_outpatient
</th>
<th>
number_inpatient
</th>
<th>
number_emergency
</th>
<th>
num_lab_procedures
</th>
<th>
number_diagnoses
</th>
<th>
num_medications
</th>
<th>
num_procedures
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
count
</th>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
<td>
143424.000000
</td>
</tr>
<tr>
<th>
mean
</th>
<td>
4.490190
</td>
<td>
0.362429
</td>
<td>
0.600855
</td>
<td>
0.195086
</td>
<td>
43.255745
</td>
<td>
7.424434
</td>
<td>
16.776035
</td>
<td>
1.349021
</td>
</tr>
<tr>
<th>
std
</th>
<td>
2.999667
</td>
<td>
1.249295
</td>
<td>
1.207934
</td>
<td>
0.920410
</td>
<td>
19.657319
</td>
<td>
1.924872
</td>
<td>
8.397130
</td>
<td>
1.719104
</td>
</tr>
<tr>
<th>
min
</th>
<td>
1.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
1.000000
</td>
<td>
1.000000
</td>
<td>
1.000000
</td>
<td>
0.000000
</td>
</tr>
<tr>
<th>
25%
</th>
<td>
2.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
32.000000
</td>
<td>
6.000000
</td>
<td>
11.000000
</td>
<td>
0.000000
</td>
</tr>
<tr>
<th>
50%
</th>
<td>
4.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
<td>
44.000000
</td>
<td>
8.000000
</td>
<td>
15.000000
</td>
<td>
1.000000
</td>
</tr>
<tr>
<th>
75%
</th>
<td>
6.000000
</td>
<td>
0.000000
</td>
<td>
1.000000
</td>
<td>
0.000000
</td>
<td>
57.000000
</td>
<td>
9.000000
</td>
<td>
21.000000
</td>
<td>
2.000000
</td>
</tr>
<tr>
<th>
max
</th>
<td>
14.000000
</td>
<td>
42.000000
</td>
<td>
21.000000
</td>
<td>
76.000000
</td>
<td>
132.000000
</td>
<td>
16.000000
</td>
<td>
81.000000
</td>
<td>
6.000000
</td>
</tr>
</tbody>

</table>
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define utility functions</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_cardinality_feature(df):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    num_rows <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    random_code_list <span class="op">=</span> np.arange(<span class="dv">100</span>, <span class="dv">1000</span>, <span class="dv">1</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.random.choice(random_code_list, num_rows)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_unique_values(df, cat_col_list):</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    cat_df <span class="op">=</span> df[cat_col_list]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    cat_df[<span class="st">'principal_diagnosis_code'</span>] <span class="op">=</span> create_cardinality_feature(cat_df)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#add feature with high cardinality</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    val_df <span class="op">=</span> pd.DataFrame({<span class="st">'columns'</span>: cat_df.columns,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'cardinality'</span>: cat_df.nunique() } )</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> val_df</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>categorical_feature_list <span class="op">=</span> [ <span class="st">'race'</span>, <span class="st">'gender'</span>, <span class="st">'age'</span>, <span class="st">'weight'</span>, <span class="st">'payer_code'</span>, <span class="st">'medical_specialty'</span>, <span class="st">'primary_diagnosis_code'</span>, <span class="st">'other_diagnosis_codes'</span>,<span class="st">'ndc_code'</span>, <span class="st">'max_glu_serum'</span>, <span class="st">'A1Cresult'</span>, <span class="st">'change'</span>, <span class="st">'readmitted'</span>]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>categorical_df <span class="op">=</span> count_unique_values(df, categorical_feature_list)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>categorical_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
columns
</th>
<th>
cardinality
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
race
</th>
<td>
race
</td>
<td>
6
</td>
</tr>
<tr>
<th>
gender
</th>
<td>
gender
</td>
<td>
3
</td>
</tr>
<tr>
<th>
age
</th>
<td>
age
</td>
<td>
10
</td>
</tr>
<tr>
<th>
weight
</th>
<td>
weight
</td>
<td>
10
</td>
</tr>
<tr>
<th>
payer_code
</th>
<td>
payer_code
</td>
<td>
18
</td>
</tr>
<tr>
<th>
medical_specialty
</th>
<td>
medical_specialty
</td>
<td>
73
</td>
</tr>
<tr>
<th>
primary_diagnosis_code
</th>
<td>
primary_diagnosis_code
</td>
<td>
717
</td>
</tr>
<tr>
<th>
other_diagnosis_codes
</th>
<td>
other_diagnosis_codes
</td>
<td>
19374
</td>
</tr>
<tr>
<th>
ndc_code
</th>
<td>
ndc_code
</td>
<td>
251
</td>
</tr>
<tr>
<th>
max_glu_serum
</th>
<td>
max_glu_serum
</td>
<td>
4
</td>
</tr>
<tr>
<th>
A1Cresult
</th>
<td>
A1Cresult
</td>
<td>
4
</td>
</tr>
<tr>
<th>
change
</th>
<td>
change
</td>
<td>
2
</td>
</tr>
<tr>
<th>
readmitted
</th>
<td>
readmitted
</td>
<td>
3
</td>
</tr>
<tr>
<th>
principal_diagnosis_code
</th>
<td>
principal_diagnosis_code
</td>
<td>
900
</td>
</tr>
</tbody>

</table>
</div>
<section id="analysis-key-findings" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="analysis-key-findings"><span class="header-section-number">5.1</span> Analysis key findings</h3>
<ul>
<li>The ndc_code field has a high amount of missing values (23460)</li>
<li>num_lab_procedures and num_medications seem to have a roughly normal distribution</li>
<li>Fields that have a high cardinality are - medical_specialty, primary_diagnosis_code, other_diagnosis_codes, ndc_code, and principal_diagnosis_code. This is because there are many thousands of these codes that correspond to the many disease and diagnosis sub-classes that exist in the medical field.</li>
<li>The distribution for the age field is approximately normal, which we would expect. The distribution for the gender field is roughly uniform &amp; equal. In this case we discount the very small number of Unknown/valid cases. Again this is not surprising, as the distribution of genders in the general population is also roughly equal so this seems to be a representitive sample from the general population.</li>
</ul>
</section>
</section>
<section id="reduce-dimensionality-of-the-ndc-code-feature" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="reduce-dimensionality-of-the-ndc-code-feature"><span class="header-section-number">6</span> Reduce Dimensionality of the NDC Code Feature</h2>
<p>NDC codes are a common format to represent the wide variety of drugs that are prescribed for patient care in the United States. The challenge is that there are many codes that map to the same or similar drug. We are provided with the ndc drug lookup file https://github.com/udacity/nd320-c1-emr-data-starter/blob/master/project/data_schema_references/ndc_lookup_table.csv derived from the National Drug Codes List site(https://ndclist.com/).</p>
<p>We can use this file to come up with a way to reduce the dimensionality of this field and create a new field in the dataset called “generic_drug_name” in the output dataframe.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#NDC code lookup file</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ndc_code_path <span class="op">=</span> <span class="st">"./medication_lookup_tables/final_ndc_lookup_table"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>ndc_code_df <span class="op">=</span> pd.read_csv(ndc_code_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check first new rows</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ndc_code_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
NDC_Code
</th>
<th>
Proprietary Name
</th>
<th>
Non-proprietary Name
</th>
<th>
Dosage Form
</th>
<th>
Route Name
</th>
<th>
Company Name
</th>
<th>
Product Type
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
0087-6060
</td>
<td>
Glucophage
</td>
<td>
Metformin Hydrochloride
</td>
<td>
Tablet, Film Coated
</td>
<td>
Oral
</td>
<td>
Bristol-myers Squibb Company
</td>
<td>
Human Prescription Drug
</td>
</tr>
<tr>
<th>
1
</th>
<td>
0087-6063
</td>
<td>
Glucophage XR
</td>
<td>
Metformin Hydrochloride
</td>
<td>
Tablet, Extended Release
</td>
<td>
Oral
</td>
<td>
Bristol-myers Squibb Company
</td>
<td>
Human Prescription Drug
</td>
</tr>
<tr>
<th>
2
</th>
<td>
0087-6064
</td>
<td>
Glucophage XR
</td>
<td>
Metformin Hydrochloride
</td>
<td>
Tablet, Extended Release
</td>
<td>
Oral
</td>
<td>
Bristol-myers Squibb Company
</td>
<td>
Human Prescription Drug
</td>
</tr>
<tr>
<th>
3
</th>
<td>
0087-6070
</td>
<td>
Glucophage
</td>
<td>
Metformin Hydrochloride
</td>
<td>
Tablet, Film Coated
</td>
<td>
Oral
</td>
<td>
Bristol-myers Squibb Company
</td>
<td>
Human Prescription Drug
</td>
</tr>
<tr>
<th>
4
</th>
<td>
0087-6071
</td>
<td>
Glucophage
</td>
<td>
Metformin Hydrochloride
</td>
<td>
Tablet, Film Coated
</td>
<td>
Oral
</td>
<td>
Bristol-myers Squibb Company
</td>
<td>
Human Prescription Drug
</td>
</tr>
</tbody>

</table>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicate NDC_Code's</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ndc_code_df[ndc_code_df.duplicated(subset<span class="op">=</span>[<span class="st">'NDC_Code'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
NDC_Code
</th>
<th>
Proprietary Name
</th>
<th>
Non-proprietary Name
</th>
<th>
Dosage Form
</th>
<th>
Route Name
</th>
<th>
Company Name
</th>
<th>
Product Type
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
263
</th>
<td>
0781-5634
</td>
<td>
Pioglitazone Hydrochloride And Glimepiride
</td>
<td>
Pioglitazone Hydrochloride And Glimepiride
</td>
<td>
Tablet
</td>
<td>
Oral
</td>
<td>
Sandoz Inc
</td>
<td>
Human Prescription Drug
</td>
</tr>
<tr>
<th>
264
</th>
<td>
0781-5635
</td>
<td>
Pioglitazone Hydrochloride And Glimepiride
</td>
<td>
Pioglitazone Hydrochloride And Glimepiride
</td>
<td>
Tablet
</td>
<td>
Oral
</td>
<td>
Sandoz Inc
</td>
<td>
Human Prescription Drug
</td>
</tr>
</tbody>

</table>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicates</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ndc_code_df <span class="op">=</span> ndc_code_df.drop(ndc_code_df.index[[<span class="dv">263</span>,<span class="dv">264</span>]])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ndc_code_df[ndc_code_df.duplicated(subset<span class="op">=</span>[<span class="st">'NDC_Code'</span>])]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
NDC_Code
</th>
<th>
Proprietary Name
</th>
<th>
Non-proprietary Name
</th>
<th>
Dosage Form
</th>
<th>
Route Name
</th>
<th>
Company Name
</th>
<th>
Product Type
</th>
</tr>
</thead>
<tbody>
</tbody>

</table>
</div>
</section>
<section id="select-first-encounter-for-each-patient" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="select-first-encounter-for-each-patient"><span class="header-section-number">7</span> Select First Encounter for each Patient</h2>
<p>In order to simplify the aggregation of data for the model, we will only select the first encounter for each patient in the dataset. This is to reduce the risk of data leakage of future patient encounters and to reduce complexity of the data transformation and modeling steps. We will assume that sorting in numerical order on the encounter_id provides the time horizon for determining which encounters come before and after another.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> select_first_encounter</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>first_encounter_df <span class="op">=</span> select_first_encounter(reduce_dim_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unique patients in transformed dataset</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>unique_patients <span class="op">=</span> first_encounter_df[<span class="st">'patient_nbr'</span>].nunique()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of unique patients:</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(unique_patients))</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># unique encounters in transformed dataset</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>unique_encounters <span class="op">=</span> first_encounter_df[<span class="st">'encounter_id'</span>].nunique()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Number of unique encounters:</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(unique_encounters))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>original_unique_patient_number <span class="op">=</span> reduce_dim_df[<span class="st">'patient_nbr'</span>].nunique()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># number of unique patients should be equal to the number of unique encounters and patients in the final dataset</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> original_unique_patient_number <span class="op">==</span> unique_patients</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> original_unique_patient_number <span class="op">==</span> unique_encounters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Number of unique patients:71518</li>
<li>Number of unique encounters:71518</li>
</ul>
</section>
<section id="aggregate-dataset-to-right-level-for-modelling" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="aggregate-dataset-to-right-level-for-modelling"><span class="header-section-number">8</span> Aggregate Dataset to Right Level for Modelling</h2>
<p>To make it simpler, we are creating dummy columns for each unique generic drug name and adding those are input features to the model.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>exclusion_list <span class="op">=</span> [<span class="st">'generic_drug_name'</span>]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>grouping_field_list <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> first_encounter_df.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> exclusion_list]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>agg_drug_df, ndc_col_list <span class="op">=</span> aggregate_dataset(first_encounter_df, grouping_field_list, <span class="st">'generic_drug_name'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(agg_drug_df) <span class="op">==</span> agg_drug_df[<span class="st">'patient_nbr'</span>].nunique() <span class="op">==</span> agg_drug_df[<span class="st">'encounter_id'</span>].nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prepare-fields-and-cast-dataset" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="prepare-fields-and-cast-dataset"><span class="header-section-number">9</span> Prepare Fields and Cast Dataset</h2>
<section id="feature-selection" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="feature-selection"><span class="header-section-number">9.1</span> Feature Selection</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at counts for payer_code categories</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"payer_code"</span>, data<span class="op">=</span>agg_drug_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_45_0.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at counts for weight categories</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.countplot(x<span class="op">=</span><span class="st">"weight"</span>, data<span class="op">=</span>agg_drug_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_46_0.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<p>From the category counts above, we can see that for payer_code while there are many unknown values i.e.&nbsp;‘?’, there are still many values for other payer codes, these may prove useful predictors for our target variable. For weight, there are so few unknown ‘?’ codes, that this feature is likely to be not very helpful for predicting our target variable.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Selected features</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>required_demo_col_list <span class="op">=</span> [<span class="st">'race'</span>, <span class="st">'gender'</span>, <span class="st">'age'</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>student_categorical_col_list <span class="op">=</span> [ <span class="st">"change"</span>, <span class="st">"readmitted"</span>, <span class="st">"payer_code"</span>, <span class="st">"medical_specialty"</span>, <span class="st">"primary_diagnosis_code"</span>, <span class="st">"other_diagnosis_codes"</span>, <span class="st">"max_glu_serum"</span>, <span class="st">"A1Cresult"</span>,  <span class="st">"admission_type_id"</span>, <span class="st">"discharge_disposition_id"</span>, <span class="st">"admission_source_id"</span>] <span class="op">+</span> required_demo_col_list <span class="op">+</span> ndc_col_list</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>student_numerical_col_list <span class="op">=</span> [<span class="st">"number_outpatient"</span>, <span class="st">"number_inpatient"</span>, <span class="st">"number_emergency"</span>, <span class="st">"num_lab_procedures"</span>, <span class="st">"number_diagnoses"</span>, <span class="st">"num_medications"</span>, <span class="st">"num_procedures"</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>PREDICTOR_FIELD <span class="op">=</span> <span class="st">'time_in_hospital'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_model_features(df, categorical_col_list, numerical_col_list, PREDICTOR_FIELD, grouping_key<span class="op">=</span><span class="st">'patient_nbr'</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    selected_col_list <span class="op">=</span> [grouping_key] <span class="op">+</span> [PREDICTOR_FIELD] <span class="op">+</span> categorical_col_list <span class="op">+</span> numerical_col_list   </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> agg_drug_df[selected_col_list]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>selected_features_df <span class="op">=</span> select_model_features(agg_drug_df, student_categorical_col_list, student_numerical_col_list,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                            PREDICTOR_FIELD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="preprocess-dataset---casting-and-imputing" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="preprocess-dataset---casting-and-imputing"><span class="header-section-number">9.2</span> Preprocess Dataset - Casting and Imputing</h3>
<p>We will cast and impute the dataset before splitting so that we do not have to repeat these steps across the splits in the next step. For imputing, there can be deeper analysis into which features to impute and how to impute but for the sake of time, we are taking a general strategy of imputing zero for only numerical features.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>processed_df <span class="op">=</span> preprocess_df(selected_features_df, student_categorical_col_list,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        student_numerical_col_list, PREDICTOR_FIELD, categorical_impute_value<span class="op">=</span><span class="st">'nan'</span>, numerical_impute_value<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="split-dataset-into-train-validation-and-test-partitions" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="split-dataset-into-train-validation-and-test-partitions"><span class="header-section-number">10</span> Split Dataset into Train, Validation, and Test Partitions</h2>
<p>In order to prepare the data for being trained and evaluated by a deep learning model, we will split the dataset into three partitions, with the validation partition used for optimizing the model hyperparameters during training. One of the key parts is that we need to be sure that the data does not accidently leak across partitions.</p>
<p>We will split the input dataset into three partitions(train, validation, test) with the following requirements:</p>
<ul>
<li>Approximately 60%/20%/20% train/validation/test split</li>
<li>Randomly sample different patients into each data partition</li>
<li>We need to take care that a patient’s data is not in more than one partition, so that we can avoid possible data leakage.</li>
<li>We need to take care the total number of unique patients across the splits is equal to the total number of unique patients in the original dataset</li>
<li>Total number of rows in original dataset = sum of rows across all three dataset partitions</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> patient_dataset_splitter</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>d_train, d_val, d_test <span class="op">=</span> patient_dataset_splitter(processed_df, <span class="st">'patient_nbr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Total number of unique patients in train = 32563</li>
<li>Total number of unique patients in validation = 10854</li>
<li>Total number of unique patients in test = 10854</li>
<li>Training partition has a shape = (32563, 43)</li>
<li>Validation partition has a shape = (10854, 43)</li>
<li>Test partition has a shape = (10854, 43)</li>
</ul>
</section>
<section id="demographic-representation-analysis-of-split" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="demographic-representation-analysis-of-split"><span class="header-section-number">11</span> Demographic Representation Analysis of Split</h2>
<p>After the split, we should check to see the distribution of key features/groups and make sure that there is representative samples across the partitions.</p>
<section id="label-distribution-across-partitions" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="label-distribution-across-partitions"><span class="header-section-number">11.1</span> Label Distribution Across Partitions</h3>
<p>Are the histogram distribution shapes similar across partitions?</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(processed_df, PREDICTOR_FIELD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_63_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(d_train, PREDICTOR_FIELD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_64_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(d_test, PREDICTOR_FIELD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_65_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
</section>
<section id="demographic-group-analysis" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="demographic-group-analysis"><span class="header-section-number">11.2</span> Demographic Group Analysis</h3>
<p>We should check that our partitions/splits of the dataset are similar in terms of their demographic profiles.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Full dataset before splitting</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>patient_demo_features <span class="op">=</span> [<span class="st">'race'</span>, <span class="st">'gender'</span>, <span class="st">'age'</span>, <span class="st">'patient_nbr'</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>patient_group_analysis_df <span class="op">=</span> processed_df[patient_demo_features].groupby(<span class="st">'patient_nbr'</span>).head(<span class="dv">1</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(patient_group_analysis_df, <span class="st">'gender'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_68_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training partition</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(d_train, <span class="st">'gender'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_69_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test partition</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>show_group_stats_viz(d_test, <span class="st">'gender'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_70_1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
</section>
</section>
<section id="convert-dataset-splits-to-tf-dataset" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="convert-dataset-splits-to-tf-dataset"><span class="header-section-number">12</span> Convert Dataset Splits to TF Dataset</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dataset from Pandas dataframes to TF dataset</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>diabetes_train_ds <span class="op">=</span> df_to_dataset(d_train, PREDICTOR_FIELD, batch_size<span class="op">=</span>batch_size)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>diabetes_val_ds <span class="op">=</span> df_to_dataset(d_val, PREDICTOR_FIELD, batch_size<span class="op">=</span>batch_size)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>diabetes_test_ds <span class="op">=</span> df_to_dataset(d_test, PREDICTOR_FIELD, batch_size<span class="op">=</span>batch_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We use this sample of the dataset to show transformations later</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>diabetes_batch <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(diabetes_train_ds))[<span class="dv">0</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> demo(feature_column, example_batch):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    feature_layer <span class="op">=</span> layers.DenseFeatures(feature_column)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(feature_layer(example_batch))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-features" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="create-features"><span class="header-section-number">13</span> Create Features</h2>
<section id="create-categorical-features-with-tf-feature-columns" class="level3" data-number="13.1">
<h3 data-number="13.1" class="anchored" data-anchor-id="create-categorical-features-with-tf-feature-columns"><span class="header-section-number">13.1</span> Create Categorical Features with TF Feature Columns</h3>
<p>Before we can create the TF categorical features, we must first create the vocab files with the unique values for a given field that are from the <strong>training</strong> dataset.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Vocabulary for Categorical Features</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>vocab_file_list <span class="op">=</span> build_vocab_files(d_train, student_categorical_col_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-categorical-features-with-tensorflow-feature-column-api" class="level3" data-number="13.2">
<h3 data-number="13.2" class="anchored" data-anchor-id="create-categorical-features-with-tensorflow-feature-column-api"><span class="header-section-number">13.2</span> Create Categorical Features with Tensorflow Feature Column API</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> create_tf_categorical_feature_cols</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>tf_cat_col_list <span class="op">=</span> create_tf_categorical_feature_cols(student_categorical_col_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>test_cat_var1 <span class="op">=</span> tf_cat_col_list[<span class="dv">0</span>]</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Example categorical field:</span><span class="ch">\n</span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(test_cat_var1))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>demo(test_cat_var1, diabetes_batch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-numerical-features-with-tf-feature-columns" class="level3" data-number="13.3">
<h3 data-number="13.3" class="anchored" data-anchor-id="create-numerical-features-with-tf-feature-columns"><span class="header-section-number">13.3</span> Create Numerical Features with TF Feature Columns</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> create_tf_numeric_feature</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_stats_from_train_data(df, col):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> df[col].describe()[<span class="st">'mean'</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> df[col].describe()[<span class="st">'std'</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean, std</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_tf_numerical_feature_cols(numerical_col_list, train_df):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    tf_numeric_col_list <span class="op">=</span> []</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c <span class="kw">in</span> numerical_col_list:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> calculate_stats_from_train_data(train_df, c)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        tf_numeric_feature <span class="op">=</span> create_tf_numeric_feature(c, mean, std)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        tf_numeric_col_list.append(tf_numeric_feature)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tf_numeric_col_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tf_cont_col_list <span class="op">=</span> create_tf_numerical_feature_cols(student_numerical_col_list, d_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>test_cont_var1 <span class="op">=</span> tf_cont_col_list[<span class="dv">0</span>]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Example continuous field:</span><span class="ch">\n</span><span class="sc">{}</span><span class="ch">\n</span><span class="st">"</span>.<span class="bu">format</span>(test_cont_var1))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>demo(test_cont_var1, diabetes_batch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="build-deep-learning-regression-model-with-sequential-api-and-tf-probability-layers"><span class="header-section-number">14</span> Build Deep Learning Regression Model with Sequential API and TF Probability Layers</h2>
<section id="use-densefeatures-to-combine-features-for-model" class="level3" data-number="14.1">
<h3 data-number="14.1" class="anchored" data-anchor-id="use-densefeatures-to-combine-features-for-model"><span class="header-section-number">14.1</span> Use DenseFeatures to combine features for model</h3>
<p>Now that we have prepared categorical and numerical features using Tensorflow’s Feature Column API, we can combine them into a dense vector representation for the model. Below we will create this new input layer, which we will call ‘claim_feature_layer’.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>claim_feature_columns <span class="op">=</span> tf_cat_col_list <span class="op">+</span> tf_cont_col_list</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>claim_feature_layer <span class="op">=</span> tf.keras.layers.DenseFeatures(claim_feature_columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="build-sequential-api-model-from-densefeatures-and-tf-probability-layers" class="level3" data-number="14.2">
<h3 data-number="14.2" class="anchored" data-anchor-id="build-sequential-api-model-from-densefeatures-and-tf-probability-layers"><span class="header-section-number">14.2</span> Build Sequential API Model from DenseFeatures and TF Probability Layers</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_sequential_model(feature_layer):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> tf.keras.Sequential([</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        feature_layer,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        tf.keras.layers.Dense(<span class="dv">150</span>, activation<span class="op">=</span><span class="st">'relu'</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        tf.keras.layers.Dense(<span class="dv">200</span>, activation<span class="op">=</span><span class="st">'relu'</span>),<span class="co"># New</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        tf.keras.layers.Dense(<span class="dv">75</span>, activation<span class="op">=</span><span class="st">'relu'</span>),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        tfp.layers.DenseVariational(<span class="dv">1</span><span class="op">+</span><span class="dv">1</span>, posterior_mean_field, prior_trainable),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        tfp.layers.DistributionLambda(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> t:tfp.distributions.Normal(loc<span class="op">=</span>t[..., :<span class="dv">1</span>],</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>                                             scale<span class="op">=</span><span class="fl">1e-3</span> <span class="op">+</span> tf.math.softplus(<span class="fl">0.01</span> <span class="op">*</span> t[...,<span class="dv">1</span>:])</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                                             )</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_diabetes_model(train_ds, val_ds,  feature_layer,  epochs<span class="op">=</span><span class="dv">5</span>, loss_metric<span class="op">=</span><span class="st">'mse'</span>):</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> build_sequential_model(feature_layer)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    opt <span class="op">=</span> tf.keras.optimizers.Adam(learning_rate<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span>opt, loss<span class="op">=</span>loss_metric, metrics<span class="op">=</span>[loss_metric])</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#model.compile(optimizer='rmsprop', loss=loss_metric, metrics=[loss_metric])</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#early_stop = tf.keras.callbacks.EarlyStopping(monitor=loss_metric, patience=3)     </span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit(train_ds, validation_data<span class="op">=</span>val_ds,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#callbacks=[early_stop],</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>                        epochs<span class="op">=</span>epochs)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, history</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>diabetes_model, history <span class="op">=</span> build_diabetes_model(diabetes_train_ds, diabetes_val_ds,  claim_feature_layer,  epochs<span class="op">=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="show-model-uncertainty-range-with-tf-probability" class="level3" data-number="14.3">
<h3 data-number="14.3" class="anchored" data-anchor-id="show-model-uncertainty-range-with-tf-probability"><span class="header-section-number">14.3</span> Show Model Uncertainty Range with TF Probability</h3>
<p>Now that we have trained a model with TF Probability layers, we can extract the mean and standard deviation for each prediction.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>feature_list <span class="op">=</span> student_categorical_col_list <span class="op">+</span> student_numerical_col_list</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>diabetes_x_tst <span class="op">=</span> <span class="bu">dict</span>(d_test[feature_list])</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>diabetes_yhat <span class="op">=</span> diabetes_model(diabetes_x_tst)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> diabetes_model.predict(diabetes_test_ds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> get_mean_std_from_preds</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>m, s <span class="op">=</span> get_mean_std_from_preds(diabetes_yhat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="show-prediction-output" class="level3" data-number="14.4">
<h3 data-number="14.4" class="anchored" data-anchor-id="show-prediction-output"><span class="header-section-number">14.4</span> Show Prediction Output</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>prob_outputs <span class="op">=</span> {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pred"</span>: preds.flatten(),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_value"</span>: d_test[<span class="st">'time_in_hospital'</span>].values,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pred_mean"</span>: m.numpy().flatten(),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pred_std"</span>: s.numpy().flatten()</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>prob_output_df <span class="op">=</span> pd.DataFrame(prob_outputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>prob_output_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
pred
</th>
<th>
actual_value
</th>
<th>
pred_mean
</th>
<th>
pred_std
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
3.587955
</td>
<td>
3.0
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
1
</th>
<td>
5.007016
</td>
<td>
2.0
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
2
</th>
<td>
4.809363
</td>
<td>
9.0
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
3
</th>
<td>
5.003417
</td>
<td>
2.0
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
4
</th>
<td>
5.346958
</td>
<td>
8.0
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
</tbody>

</table>
</div>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>prob_output_df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
pred
</th>
<th>
actual_value
</th>
<th>
pred_mean
</th>
<th>
pred_std
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
count
</th>
<td>
10854.000000
</td>
<td>
10854.000000
</td>
<td>
10854.000000
</td>
<td>
10854.000000
</td>
</tr>
<tr>
<th>
mean
</th>
<td>
4.376980
</td>
<td>
4.429888
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
std
</th>
<td>
0.908507
</td>
<td>
3.002044
</td>
<td>
0.000000
</td>
<td>
0.000000
</td>
</tr>
<tr>
<th>
min
</th>
<td>
0.976290
</td>
<td>
1.000000
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
25%
</th>
<td>
3.755292
</td>
<td>
2.000000
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
50%
</th>
<td>
4.382993
</td>
<td>
4.000000
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
75%
</th>
<td>
5.002859
</td>
<td>
6.000000
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
<tr>
<th>
max
</th>
<td>
7.529900
</td>
<td>
14.000000
</td>
<td>
4.673843
</td>
<td>
0.693749
</td>
</tr>
</tbody>

</table>
</div>
</section>
<section id="convert-regression-output-to-classification-output-for-patient-selection" class="level3" data-number="14.5">
<h3 data-number="14.5" class="anchored" data-anchor-id="convert-regression-output-to-classification-output-for-patient-selection"><span class="header-section-number">14.5</span> Convert Regression Output to Classification Output for Patient Selection</h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> student_utils <span class="im">import</span> get_student_binary_prediction</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>student_binary_prediction <span class="op">=</span> get_student_binary_prediction(prob_output_df, <span class="st">'pred'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>student_binary_prediction.value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>0:8137</li>
<li>1:2717</li>
</ul>
</section>
<section id="add-binary-prediction-to-test-dataframe" class="level3" data-number="14.6">
<h3 data-number="14.6" class="anchored" data-anchor-id="add-binary-prediction-to-test-dataframe"><span class="header-section-number">14.6</span> Add Binary Prediction to Test Dataframe</h3>
<p>Using the student_binary_prediction output that is a numpy array with binary labels, we can use this to add to a dataframe to better visualize and also to prepare the data for the Aequitas toolkit. The Aequitas toolkit requires that the predictions be mapped to a binary label for the predictions (called ‘score’ field) and the actual value (called ‘label_value’).</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_pred_to_test(test_df, pred_np, demo_col_list):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c <span class="kw">in</span> demo_col_list:</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        test_df[c] <span class="op">=</span> test_df[c].astype(<span class="bu">str</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'score'</span>] <span class="op">=</span> pred_np</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'label_value'</span>] <span class="op">=</span> test_df[<span class="st">'time_in_hospital'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">&gt;=</span><span class="dv">5</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_df</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>pred_test_df <span class="op">=</span> add_pred_to_test(d_test, student_binary_prediction, [<span class="st">'race'</span>, <span class="st">'gender'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>pred_test_df[[<span class="st">'patient_nbr'</span>, <span class="st">'gender'</span>, <span class="st">'race'</span>, <span class="st">'time_in_hospital'</span>, <span class="st">'score'</span>, <span class="st">'label_value'</span>]].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
patient_nbr
</th>
<th>
gender
</th>
<th>
race
</th>
<th>
time_in_hospital
</th>
<th>
score
</th>
<th>
label_value
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
122896787
</td>
<td>
Male
</td>
<td>
Caucasian
</td>
<td>
3.0
</td>
<td>
0
</td>
<td>
0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
102598929
</td>
<td>
Male
</td>
<td>
Caucasian
</td>
<td>
2.0
</td>
<td>
1
</td>
<td>
0
</td>
</tr>
<tr>
<th>
2
</th>
<td>
80367957
</td>
<td>
Male
</td>
<td>
Caucasian
</td>
<td>
9.0
</td>
<td>
0
</td>
<td>
1
</td>
</tr>
<tr>
<th>
3
</th>
<td>
6721533
</td>
<td>
Male
</td>
<td>
Caucasian
</td>
<td>
2.0
</td>
<td>
1
</td>
<td>
0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
104346288
</td>
<td>
Female
</td>
<td>
Caucasian
</td>
<td>
8.0
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
</tbody>

</table>
</div>
</section>
</section>
<section id="model-evaluation-metrics" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="model-evaluation-metrics"><span class="header-section-number">15</span> Model Evaluation Metrics</h2>
<p>Now it is time to use the newly created binary labels in the ‘pred_test_df’ dataframe to evaluate the model with some common classification metrics. We will create a report summary of the performance of the model and give the ROC AUC, F1 score(weighted), class precision and recall scores.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC, F1, precision and recall</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> pred_test_df[<span class="st">'label_value'</span>].values</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> pred_test_df[<span class="st">'score'</span>].values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>accuracy_score(y_true, y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>0.5627418463239359</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>roc_auc_score(y_true, y_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>0.5032089104088319</li>
</ul>
<p>Precision-recall tradeoff - The model has been optimised to identify those patients correct for the trial with the fewest mistakes, while also trying to ensure we identify as many of them as possible.</p>
<p>Areas of imporovement - we could look to engineer new features that might help us better predict our target patients.</p>
</section>
<section id="evaluating-potential-model-biases-with-aequitas-toolkit" class="level2" data-number="16">
<h2 data-number="16" class="anchored" data-anchor-id="evaluating-potential-model-biases-with-aequitas-toolkit"><span class="header-section-number">16</span> Evaluating Potential Model Biases with Aequitas Toolkit</h2>
<section id="prepare-data-for-aequitas-bias-toolkit" class="level3" data-number="16.1">
<h3 data-number="16.1" class="anchored" data-anchor-id="prepare-data-for-aequitas-bias-toolkit"><span class="header-section-number">16.1</span> Prepare Data For Aequitas Bias Toolkit</h3>
<p>Using the gender and race fields, we will prepare the data for the Aequitas Toolkit.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aequitas</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aequitas.preprocessing <span class="im">import</span> preprocess_input_df</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aequitas.group <span class="im">import</span> Group</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aequitas.plotting <span class="im">import</span> Plot</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aequitas.bias <span class="im">import</span> Bias</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aequitas.fairness <span class="im">import</span> Fairness</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>ae_subset_df <span class="op">=</span> pred_test_df[[<span class="st">'race'</span>, <span class="st">'gender'</span>, <span class="st">'score'</span>, <span class="st">'label_value'</span>]]</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>ae_df, _ <span class="op">=</span> preprocess_input_df(ae_subset_df)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> Group()</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>xtab, _ <span class="op">=</span> g.get_crosstabs(ae_df)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>absolute_metrics <span class="op">=</span> g.list_absolute_metrics(xtab)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>clean_xtab <span class="op">=</span> xtab.fillna(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>aqp <span class="op">=</span> Plot()</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> Bias()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>model_id, score_thresholds 1 {‘rank_abs’: [2717]}</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>absolute_metrics <span class="op">=</span> g.list_absolute_metrics(xtab)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>xtab[[col <span class="cf">for</span> col <span class="kw">in</span> xtab.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> absolute_metrics]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
model_id
</th>
<th>
score_threshold
</th>
<th>
k
</th>
<th>
attribute_name
</th>
<th>
attribute_value
</th>
<th>
pp
</th>
<th>
pn
</th>
<th>
fp
</th>
<th>
fn
</th>
<th>
tn
</th>
<th>
tp
</th>
<th>
group_label_pos
</th>
<th>
group_label_neg
</th>
<th>
group_size
</th>
<th>
total_entities
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
?
</td>
<td>
86
</td>
<td>
240
</td>
<td>
56
</td>
<td>
85
</td>
<td>
155
</td>
<td>
30
</td>
<td>
115
</td>
<td>
211
</td>
<td>
326
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
1
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
AfricanAmerican
</td>
<td>
491
</td>
<td>
1530
</td>
<td>
291
</td>
<td>
592
</td>
<td>
938
</td>
<td>
200
</td>
<td>
792
</td>
<td>
1229
</td>
<td>
2021
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
2
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
Asian
</td>
<td>
15
</td>
<td>
60
</td>
<td>
10
</td>
<td>
16
</td>
<td>
44
</td>
<td>
5
</td>
<td>
21
</td>
<td>
54
</td>
<td>
75
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
3
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
Caucasian
</td>
<td>
2030
</td>
<td>
6038
</td>
<td>
1249
</td>
<td>
2298
</td>
<td>
3740
</td>
<td>
781
</td>
<td>
3079
</td>
<td>
4989
</td>
<td>
8068
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
4
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
Hispanic
</td>
<td>
52
</td>
<td>
141
</td>
<td>
35
</td>
<td>
48
</td>
<td>
93
</td>
<td>
17
</td>
<td>
65
</td>
<td>
128
</td>
<td>
193
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
5
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
race
</td>
<td>
Other
</td>
<td>
43
</td>
<td>
128
</td>
<td>
26
</td>
<td>
40
</td>
<td>
88
</td>
<td>
17
</td>
<td>
57
</td>
<td>
114
</td>
<td>
171
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
6
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
gender
</td>
<td>
Female
</td>
<td>
1413
</td>
<td>
4306
</td>
<td>
820
</td>
<td>
1675
</td>
<td>
2631
</td>
<td>
593
</td>
<td>
2268
</td>
<td>
3451
</td>
<td>
5719
</td>
<td>
10854
</td>
</tr>
<tr>
<th>
7
</th>
<td>
1
</td>
<td>
binary 0/1
</td>
<td>
2717
</td>
<td>
gender
</td>
<td>
Male
</td>
<td>
1304
</td>
<td>
3831
</td>
<td>
847
</td>
<td>
1404
</td>
<td>
2427
</td>
<td>
457
</td>
<td>
1861
</td>
<td>
3274
</td>
<td>
5135
</td>
<td>
10854
</td>
</tr>
</tbody>

</table>
</div>
</section>
<section id="reference-group-selection" class="level3" data-number="16.2">
<h3 data-number="16.2" class="anchored" data-anchor-id="reference-group-selection"><span class="header-section-number">16.2</span> Reference Group Selection</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test reference group with Caucasian Male</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>bdf <span class="op">=</span> b.get_disparity_predefined_groups(clean_xtab,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                    original_df<span class="op">=</span>ae_df,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                    ref_groups_dict<span class="op">=</span>{<span class="st">'race'</span>:<span class="st">'Caucasian'</span>, <span class="st">'gender'</span>:<span class="st">'Male'</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                                     },</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                    alpha<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                    check_significance<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> Fairness()</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>fdf <span class="op">=</span> f.get_group_value_fairness(bdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="race-and-gender-bias-analysis-for-patient-selection" class="level3" data-number="16.3">
<h3 data-number="16.3" class="anchored" data-anchor-id="race-and-gender-bias-analysis-for-patient-selection"><span class="header-section-number">16.3</span> Race and Gender Bias Analysis for Patient Selection</h3>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot two metrics</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Is there significant bias in your model for either race or gender?</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>fpr_disparity1 <span class="op">=</span> aqp.plot_disparity(bdf, group_metric<span class="op">=</span><span class="st">'fpr_disparity'</span>, attribute_name<span class="op">=</span><span class="st">'race'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_122_0.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<p>We notice that while with most races, there is no significant indication of bias, there is an indication that Asians are less likely to be itentified by the model, based on the 0.4 disparity in relation to the Caucasian reference group.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>fpr_disparity2 <span class="op">=</span> aqp.plot_disparity(bdf, group_metric<span class="op">=</span><span class="st">'fpr_disparity'</span>, attribute_name<span class="op">=</span><span class="st">'gender'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_124_0.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<p>With gender, there does not seem to be any significant indication of bias.</p>
</section>
<section id="fairness-analysis-example---relative-to-a-reference-group" class="level3" data-number="16.4">
<h3 data-number="16.4" class="anchored" data-anchor-id="fairness-analysis-example---relative-to-a-reference-group"><span class="header-section-number">16.4</span> Fairness Analysis Example - Relative to a Reference Group</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reference group fairness plot</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>fpr_fairness <span class="op">=</span> aqp.plot_fairness_group(fdf, group_metric<span class="op">=</span><span class="st">'fpr'</span>, title<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://github.com/pranath/blog/raw/master/images/diabetes/output_127_0.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">png</figcaption>
</figure>
</div>
<p>Here again we can see that there appears to be signficant disparity with the Asian race being under-represented with a magnitude of 0.19.</p>


</section>
</section>

<a href="https://thefuturai.substack.com/"><h2 class="anchored">Subscribe</h2></a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("http:\/\/livingdatalab\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">LivingDataLab AI Technical Blog</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>