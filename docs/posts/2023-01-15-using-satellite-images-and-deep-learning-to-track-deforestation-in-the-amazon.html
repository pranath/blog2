<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pranath Fernando">
<meta name="dcterms.date" content="2023-01-15">
<meta name="description" content="In this project we will be using a deep learning model to classify satellite images of the amazon rain forest. Here the main objective is not to get the best results for this task, rather to use this dataset to illustrate the use of the Fastai deep learning library">

<title>LivingDataLab - Using Satellite Images and Deep Learning to Track Deforestation in the Amazon</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-91568149-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../css/styles.css">
<meta property="og:title" content="LivingDataLab - Using Satellite Images and Deep Learning to Track Deforestation in the Amazon">
<meta property="og:description" content="In this project we will be using a deep learning model to classify satellite images of the amazon rain forest.">
<meta property="og:image" content="https://github.com/pranath/blog/raw/master/images/amazon_deforrest.jpg">
<meta property="og:site-name" content="LivingDataLab">
<meta name="twitter:title" content="LivingDataLab - Using Satellite Images and Deep Learning to Track Deforestation in the Amazon">
<meta name="twitter:description" content="In this project we will be using a deep learning model to classify satellite images of the amazon rain forest.">
<meta name="twitter:image" content="https://github.com/pranath/blog/raw/master/images/amazon_deforrest.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">LivingDataLab</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../projects.html" aria-current="page">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/pranath-fernando/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/LivingDataLab"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pranath"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Using Satellite Images and Deep Learning to Track Deforestation in the Amazon</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title d-none d-lg-block">Using Satellite Images and Deep Learning to Track Deforestation in the Amazon</h1>
                  <div>
        <div class="description">
          In this project we will be using a deep learning model to classify satellite images of the amazon rain forest. Here the main objective is not to get the best results for this task, rather to use this dataset to illustrate the use of the Fastai deep learning library
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">fastai</div>
                <div class="quarto-category">deep-learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Pranath Fernando </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 15, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects.html" class="sidebar-item-text sidebar-link">Projects Overview</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Projects</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/doc-chat.html" class="sidebar-item-text sidebar-link">Document Chat</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/doc-summarisation.html" class="sidebar-item-text sidebar-link">Document Summarisation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/web-page-chat.html" class="sidebar-item-text sidebar-link">Web Page Chat</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/web-page-summarisation.html" class="sidebar-item-text sidebar-link">Web Page Summarisation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/youtube-chat.html" class="sidebar-item-text sidebar-link">YouTube Chat</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../projects/youtube-summarisation.html" class="sidebar-item-text sidebar-link">YouTube Summarisation</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<!-- Begin Mailchimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/classic-071822.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
    /* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
    <form action="https://livingdatalab.us8.list-manage.com/subscribe/post?u=e2d57b0d6e43b4f6bff927a55&amp;id=a30bdff125&amp;f_id=009d05e0f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
        <div id="mc_embed_signup_scroll">
        <h2>Subscribe</h2>
<div class="mc-field-group">
    <label for="mce-EMAIL">Email Address
</label>
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required="">
    <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
    <div id="mce-responses" class="clear foot">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_e2d57b0d6e43b4f6bff927a55_a30bdff125" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
            </div>
        </div>
    </div>
</form>
</div>
<script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
<!--End mc_embed_signup-->

</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="toc-section-number">1</span>  Introduction</a></li>
  <li><a href="#using-fastai-to-prepare-data-for-the-amazon-image-classification-task" id="toc-using-fastai-to-prepare-data-for-the-amazon-image-classification-task" class="nav-link" data-scroll-target="#using-fastai-to-prepare-data-for-the-amazon-image-classification-task"><span class="toc-section-number">2</span>  Using Fastai to prepare data for the Amazon Image classification task</a></li>
  <li><a href="#loading-and-examining-the-data" id="toc-loading-and-examining-the-data" class="nav-link" data-scroll-target="#loading-and-examining-the-data"><span class="toc-section-number">3</span>  Loading and examining the data</a></li>
  <li><a href="#the-fastai-layered-api" id="toc-the-fastai-layered-api" class="nav-link" data-scroll-target="#the-fastai-layered-api"><span class="toc-section-number">4</span>  The Fastai layered API</a>
  <ul class="collapse">
  <li><a href="#using-the-high-level-api" id="toc-using-the-high-level-api" class="nav-link" data-scroll-target="#using-the-high-level-api"><span class="toc-section-number">4.1</span>  Using the High Level API</a></li>
  <li><a href="#using-the-mid-level-api---version-1" id="toc-using-the-mid-level-api---version-1" class="nav-link" data-scroll-target="#using-the-mid-level-api---version-1"><span class="toc-section-number">4.2</span>  Using the Mid Level API - Version 1</a></li>
  <li><a href="#using-the-mid-level-api---version-2" id="toc-using-the-mid-level-api---version-2" class="nav-link" data-scroll-target="#using-the-mid-level-api---version-2"><span class="toc-section-number">4.3</span>  Using the Mid Level API - Version 2</a></li>
  <li><a href="#using-the-mid-level-api---version-3" id="toc-using-the-mid-level-api---version-3" class="nav-link" data-scroll-target="#using-the-mid-level-api---version-3"><span class="toc-section-number">4.4</span>  Using the Mid Level API - Version 3</a></li>
  <li><a href="#using-the-mid-level-api---version-4" id="toc-using-the-mid-level-api---version-4" class="nav-link" data-scroll-target="#using-the-mid-level-api---version-4"><span class="toc-section-number">4.5</span>  Using the Mid Level API - Version 4</a></li>
  <li><a href="#training-our-model-more" id="toc-training-our-model-more" class="nav-link" data-scroll-target="#training-our-model-more"><span class="toc-section-number">4.6</span>  Training our Model More</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="toc-section-number">5</span>  Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In this project we will be using a deep learning model to help classify satellite images of the amazon rain forest. <strong>Here the main objective is not actually to get the best results for this task, rather to use this dataset to illustrate the use of the Fastai deep learning library</strong> - in particular to demonstrate the uses of the high-level api as well as the mid-level api and show how this can be used to configure different types of datasets for different types of problems.</p>
</section>
<section id="using-fastai-to-prepare-data-for-the-amazon-image-classification-task" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="using-fastai-to-prepare-data-for-the-amazon-image-classification-task"><span class="header-section-number">2</span> Using Fastai to prepare data for the Amazon Image classification task</h2>
<p>The amazon dataset comes from the <a href="https://www.kaggle.com/competitions/planet-understanding-the-amazon-from-space">Understanding the Amazon from Space</a> project, which aims:</p>
<blockquote class="blockquote">
<p>‘…to label satellite image chips with atmospheric conditions and various classes of land cover/land use. Resulting algorithms will help the global community better understand where, how, and why deforestation happens all over the world - and ultimately how to respond.’</p>
</blockquote>
<p>Key aspects of this task include.</p>
<ul>
<li>Our data consists of images as well as multiple labels for each image</li>
<li>Our task is <em>Multi-label Classification</em> i.e.&nbsp;to be able to predict one or more labels for a given image</li>
</ul>
<p>While the main dataset has over 40,000 images - we will be using a small subset of this of just 200 images.</p>
<p>In an earlier project I looked at a different dataset of satellite images, in this case for an <a href="2021-05-15-satellite-recognition-buildings-woodland-water-ai.html">image segmentation task rather than classification</a>.</p>
</section>
<section id="loading-and-examining-the-data" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="loading-and-examining-the-data"><span class="header-section-number">3</span> Loading and examining the data</h2>
<p>Let’s see how we can use the Fastai library to prepare our data to perform this task, and start by loading the data.</p>
<div class="cell" data-outputid="7a87a3fa-37ec-464d-c448-15885ffc1ce2" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PLANET_TINY)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>(#3) [Path('/root/.fastai/data/planet_tiny/labels.csv'),Path('/root/.fastai/data/planet_tiny/models'),Path('/root/.fastai/data/planet_tiny/train')]</code></pre>
</div>
</div>
<p>So we have a folder called ‘train’ which we assume has the images, lets take a look to check.</p>
<div class="cell" data-outputid="dd002822-29a6-4111-a9b8-aafbbee59ebe" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(path<span class="op">/</span><span class="st">"train"</span>).ls()[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>(#5) [Path('/root/.fastai/data/planet_tiny/train/train_39223.jpg'),Path('/root/.fastai/data/planet_tiny/train/train_5302.jpg'),Path('/root/.fastai/data/planet_tiny/train/train_34793.jpg'),Path('/root/.fastai/data/planet_tiny/train/train_28156.jpg'),Path('/root/.fastai/data/planet_tiny/train/train_15839.jpg')]</code></pre>
</div>
</div>
<p>We also have a labels.csv file, which would normally have the image names and their associated labels, lets verify this.</p>
<div class="cell" data-outputid="daabefdb-3fe5-4b24-f79e-1bf2c1985215" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">"labels.csv"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">


  <div id="df-9d5aa2e9-296f-4abc-8109-47ff26223573">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image_name</th>
      <th>tags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>train_31112</td>
      <td>clear primary</td>
    </tr>
    <tr>
      <th>1</th>
      <td>train_4300</td>
      <td>partly_cloudy primary water</td>
    </tr>
    <tr>
      <th>2</th>
      <td>train_39539</td>
      <td>clear primary water</td>
    </tr>
    <tr>
      <th>3</th>
      <td>train_12498</td>
      <td>agriculture clear primary road</td>
    </tr>
    <tr>
      <th>4</th>
      <td>train_9320</td>
      <td>clear primary</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-9d5aa2e9-296f-4abc-8109-47ff26223573')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-9d5aa2e9-296f-4abc-8109-47ff26223573 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-9d5aa2e9-296f-4abc-8109-47ff26223573');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>Let’s check how many images we have.</p>
<div class="cell" data-outputid="45f3de6e-d8df-4613-e4be-9acaf5d095fa" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>(200, 2)</code></pre>
</div>
</div>
<p>So this is a <em>multi-label classification</em> task, each image has one or more labels which we hope to predict. Lets get an idea of how many example images we have for each label.</p>
<div class="cell" data-outputid="77a3d10a-4a57-496a-ba16-37b5ce1b0805" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>new_df <span class="op">=</span> df[<span class="st">'tags'</span>].<span class="bu">str</span>.split(expand<span class="op">=</span><span class="va">True</span>).stack().value_counts().reset_index()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>new_df.columns <span class="op">=</span> [<span class="st">'Word'</span>, <span class="st">'Frequency'</span>] </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_df.shape)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>new_df.head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(14, 2)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">


  <div id="df-3afd105e-e4e7-4f9a-a604-b0d5cfccd96d">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Word</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>primary</td>
      <td>190</td>
    </tr>
    <tr>
      <th>1</th>
      <td>clear</td>
      <td>139</td>
    </tr>
    <tr>
      <th>2</th>
      <td>agriculture</td>
      <td>61</td>
    </tr>
    <tr>
      <th>3</th>
      <td>partly_cloudy</td>
      <td>42</td>
    </tr>
    <tr>
      <th>4</th>
      <td>road</td>
      <td>41</td>
    </tr>
    <tr>
      <th>5</th>
      <td>water</td>
      <td>31</td>
    </tr>
    <tr>
      <th>6</th>
      <td>cultivation</td>
      <td>28</td>
    </tr>
    <tr>
      <th>7</th>
      <td>habitation</td>
      <td>19</td>
    </tr>
    <tr>
      <th>8</th>
      <td>haze</td>
      <td>11</td>
    </tr>
    <tr>
      <th>9</th>
      <td>cloudy</td>
      <td>8</td>
    </tr>
    <tr>
      <th>10</th>
      <td>bare_ground</td>
      <td>5</td>
    </tr>
    <tr>
      <th>11</th>
      <td>artisinal_mine</td>
      <td>4</td>
    </tr>
    <tr>
      <th>12</th>
      <td>blooming</td>
      <td>3</td>
    </tr>
    <tr>
      <th>13</th>
      <td>selective_logging</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-3afd105e-e4e7-4f9a-a604-b0d5cfccd96d')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-3afd105e-e4e7-4f9a-a604-b0d5cfccd96d button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-3afd105e-e4e7-4f9a-a604-b0d5cfccd96d');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>So we can see this is a very imbalanced dataset, some labels such as <em>primary</em> occur alot, wheras other labels such as <em>selective_logging</em> only occur twice.</p>
<p>As we are mainly focussing on the use of fastai not making the best model, we will be using the fastest method of creating a training &amp; validation datasets using the random split method. Given we have some categories that don’t have many examples, if we do a random split its possible we could have some labels only in the training or valdiation sets, and this will create an error as we can’t have labels in the validation set that are not in the training set.</p>
<p>Let’s deal with this by removing the images that have low-frequency labels, to try to reduce the risk of this error so we can focus on how to use the fastai library.</p>
<div class="cell" data-outputid="10cf63c9-722f-4607-9c39-bd9a8bd9af75" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.copy()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">"tags"</span>].<span class="bu">str</span>.contains(<span class="st">"haze|cloudy|bare_ground|artisinal_mine|blooming|selective_logging"</span>) <span class="op">==</span> <span class="va">False</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>new_df <span class="op">=</span> df[<span class="st">'tags'</span>].<span class="bu">str</span>.split(expand<span class="op">=</span><span class="va">True</span>).stack().value_counts().reset_index()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>new_df.columns <span class="op">=</span> [<span class="st">'Word'</span>, <span class="st">'Frequency'</span>] </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_df.shape)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>new_df.head(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(7, 2)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">


  <div id="df-e4fc5de0-13ce-4e90-9d90-d7d7014bceb3">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>Word</th>
      <th>Frequency</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>clear</td>
      <td>127</td>
    </tr>
    <tr>
      <th>1</th>
      <td>primary</td>
      <td>126</td>
    </tr>
    <tr>
      <th>2</th>
      <td>agriculture</td>
      <td>38</td>
    </tr>
    <tr>
      <th>3</th>
      <td>road</td>
      <td>26</td>
    </tr>
    <tr>
      <th>4</th>
      <td>water</td>
      <td>18</td>
    </tr>
    <tr>
      <th>5</th>
      <td>cultivation</td>
      <td>14</td>
    </tr>
    <tr>
      <th>6</th>
      <td>habitation</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-e4fc5de0-13ce-4e90-9d90-d7d7014bceb3')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-e4fc5de0-13ce-4e90-9d90-d7d7014bceb3 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-e4fc5de0-13ce-4e90-9d90-d7d7014bceb3');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>We now have a second issue to deal with, the image names in our labels.csv is not a complete file name, this will make it more difficult to read in the image files. Lets create a new column that has the complete image file name.</p>
<div class="cell" data-outputid="225a7282-926e-458d-edf6-c96d719a88e6" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'filename'</span>] <span class="op">=</span> df[<span class="st">'image_name'</span>] <span class="op">+</span> <span class="st">'.jpg'</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">


  <div id="df-bf48662a-d33c-4f9e-8c3c-f8c6bea0a5aa">
    <div class="colab-df-container">
      <div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>image_name</th>
      <th>tags</th>
      <th>filename</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>train_31112</td>
      <td>clear primary</td>
      <td>train_31112.jpg</td>
    </tr>
    <tr>
      <th>2</th>
      <td>train_39539</td>
      <td>clear primary water</td>
      <td>train_39539.jpg</td>
    </tr>
    <tr>
      <th>3</th>
      <td>train_12498</td>
      <td>agriculture clear primary road</td>
      <td>train_12498.jpg</td>
    </tr>
    <tr>
      <th>4</th>
      <td>train_9320</td>
      <td>clear primary</td>
      <td>train_9320.jpg</td>
    </tr>
    <tr>
      <th>5</th>
      <td>train_28430</td>
      <td>agriculture clear cultivation primary road</td>
      <td>train_28430.jpg</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-bf48662a-d33c-4f9e-8c3c-f8c6bea0a5aa')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-bf48662a-d33c-4f9e-8c3c-f8c6bea0a5aa button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-bf48662a-d33c-4f9e-8c3c-f8c6bea0a5aa');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
</section>
<section id="the-fastai-layered-api" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="the-fastai-layered-api"><span class="header-section-number">4</span> The Fastai layered API</h2>
<p>In a previous article i gave an introduction to the <a href="https://livingdatalab.com/fastai/2021/05/30/fastai-midlevel-api.html">Fastai layered API</a></p>
<p><img src="https://github.com/pranath/blog/raw/master/images/fastai-layered.png" title="The Fastai layered API" class="img-fluid"></p>
<p>In this article we will make use of the High &amp; Mid level API.</p>
<section id="using-the-high-level-api" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="using-the-high-level-api"><span class="header-section-number">4.1</span> Using the High Level API</h3>
<p>This level API is the simplest to use, having many preset defaults that make it easy to load and setup data for a range of deep learning tasks.</p>
<p>Let’s use it now to set up our amazon image data.</p>
<div class="cell" data-outputid="677d2a11-f292-4d4a-d198-58a75e09da3c" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_df(df, path, fn_col<span class="op">=</span><span class="dv">2</span>, folder<span class="op">=</span><span class="st">'train'</span>, label_delim<span class="op">=</span><span class="st">' '</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                               item_tfms<span class="op">=</span>Resize(<span class="dv">460</span>), batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>So a few things to note which the Fastai high level api has done:</p>
<ul>
<li>It’s used our dataframe to load the data</li>
<li>It uses the <em>path</em> variable to know which file path the images are located</li>
<li>The ‘fn_col’ parameter tells it which column to use for the filenames, in this case column 2 is the new column we created for the complete filename</li>
<li>The <em>folder</em> parameter tells it where the images are located under <em>path</em></li>
<li>The <em>label_delim</em> parameter tells it how to split the labels, in this case separated by spaces</li>
<li><em>item_tfms</em> a list of one or several transforms applied to the items before batching them for model training</li>
<li><em>batch_tfms</em> a list of one or several transforms applied to batches of images once they are formed during model training</li>
</ul>
<p>So we can see we have a good level of configurability even at the high level api.</p>
<p><a href="https://docs.fast.ai/vision.data.html">There are many other high level api functions for Fastai vision applications for loading different types of data</a>.</p>
<p>It will also be helpful to set up some metrics to measure our progress during training, specific to being a multi labelled classification task, and having an unbalanced dataset. A Good metric for this situation would be an F1 score for multiple classes, so lets set up some metrics for this now.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>f1_macro <span class="op">=</span> F1ScoreMulti(thresh<span class="op">=</span><span class="fl">0.5</span>, average<span class="op">=</span><span class="st">'macro'</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>f1_macro.name <span class="op">=</span> <span class="st">'F1(macro)'</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>f1_samples <span class="op">=</span> F1ScoreMulti(thresh<span class="op">=</span><span class="fl">0.5</span>, average<span class="op">=</span><span class="st">'samples'</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>f1_samples.name <span class="op">=</span> <span class="st">'F1(samples)'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So we are almost ready to create our model and start training.</p>
<p>One consideration we have when creating a model is which model to use? as of date of this article, there are many pre-trained deep learning vision models, and many new ones being added. Which should we use?</p>
<p>Jeremy Howard, one of the co-founders of FastAI completed <a href="https://www.kaggle.com/code/jhoward/the-best-vision-models-for-fine-tuning">a project where he looked at a number recent of vision models and evaluated and ranked them by different criteria</a>.</p>
<p>These were based on Ros Wightmanns list of Pytorch state of the art image models library <a href="https://timm.fast.ai/">timm</a>.</p>
<p>Looking at these models and considering this use case: i’d like the best performing model but the best <em>smallest</em> model as we are not focussing here on getting the best results, rather to just demonstrate the usage of the Fastai library.</p>
<p>So looking with this criteria, i’ve selected the ‘convnext_small_in22k’ pre-trained image model to use.</p>
<p>Let’s now create the model using the high-level api function <em>vision_learner</em>.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, <span class="st">'convnext_small_in22k'</span>, metrics<span class="op">=</span>[partial(accuracy_multi, thresh<span class="op">=</span><span class="fl">0.5</span>), f1_macro, f1_samples])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So we have created our model, using our data, and added the metrics to use.</p>
<p>But what about the model learning rate? for this we can use another great Fastai api function <em>lr_find()</em>.</p>
<p>For more information on this concept and the research behind it, including discriminative learning rates this is a <a href="https://towardsdatascience.com/why-i-use-fastai-and-you-should-too-a421f6c99508">great article</a>.</p>
<div class="cell" data-outputid="9d92276c-99aa-4944-c346-1d452ebf0266" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-13-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>So this gives us a good idea of the a good learning rate to use, lets set this and train the model for 2 epochs.</p>
<div class="cell" data-outputid="9c62fa39-a651-4ae7-8200-91be3a84fb1d" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">2</span>, <span class="fl">3e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>F1(macro)</th>
      <th>F1(samples)</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.044040</td>
      <td>2.020892</td>
      <td>0.497143</td>
      <td>0.312559</td>
      <td>0.430190</td>
      <td>00:02</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>F1(macro)</th>
      <th>F1(samples)</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.955900</td>
      <td>1.813314</td>
      <td>0.411429</td>
      <td>0.347462</td>
      <td>0.411784</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.914945</td>
      <td>1.890064</td>
      <td>0.554286</td>
      <td>0.363607</td>
      <td>0.453518</td>
      <td>00:04</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>We can see our model is slowly starting to improve.</p>
<p>Let’s see how our model is predicting labels for our satellite images.</p>
<div class="cell" data-outputid="8d84cc30-51ed-4674-878d-e24705bc762a" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-15-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>We can also get an idea of which images the model finds hardest to predict by using the <em>plot_top_losses()</em> function.</p>
<div class="cell" data-outputid="69e82aa9-9fe4-4974-9c95-507cc216f538" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> Interpretation.from_learner(learn)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>target</th>
      <th>predicted</th>
      <th>probabilities</th>
      <th>loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>clear;habitation;primary;road;water</td>
      <td>agriculture;cultivation;habitation;road;water</td>
      <td>TensorBase([1.0000e+00, 5.3429e-10, 9.1896e-01, 5.3812e-01, 1.8748e-02,\n            9.9999e-01, 9.9779e-01])</td>
      <td>5.9950785636901855</td>
    </tr>
    <tr>
      <th>1</th>
      <td>agriculture;clear;habitation;primary;road</td>
      <td>agriculture;cultivation;habitation;primary;road;water</td>
      <td>TensorBase([1.0000e+00, 1.3865e-08, 9.7993e-01, 9.4586e-01, 5.2794e-01,\n            9.9999e-01, 9.9923e-01])</td>
      <td>4.266438961029053</td>
    </tr>
    <tr>
      <th>2</th>
      <td>clear;primary;water</td>
      <td>agriculture;habitation;primary;road;water</td>
      <td>TensorBase([9.9979e-01, 5.7836e-05, 1.7540e-01, 7.1101e-01, 5.7885e-01,\n            9.9740e-01, 9.9980e-01])</td>
      <td>3.7381298542022705</td>
    </tr>
    <tr>
      <th>3</th>
      <td>clear;cultivation;primary</td>
      <td>agriculture;road;water</td>
      <td>TensorBase([9.9726e-01, 3.5533e-04, 2.8459e-01, 3.0627e-01, 3.5213e-01,\n            9.9678e-01, 9.3701e-01])</td>
      <td>3.573106050491333</td>
    </tr>
    <tr>
      <th>4</th>
      <td>agriculture;clear;habitation;primary;road;water</td>
      <td>agriculture;habitation;primary;road;water</td>
      <td>TensorBase([9.9999e-01, 6.4912e-11, 1.6498e-01, 8.6925e-01, 8.6978e-01,\n            1.0000e+00, 9.9922e-01])</td>
      <td>3.4169580936431885</td>
    </tr>
    <tr>
      <th>5</th>
      <td>agriculture;clear;primary;road</td>
      <td>agriculture;cultivation;habitation;road;water</td>
      <td>TensorBase([9.9999e-01, 3.5587e-06, 6.8011e-01, 5.0741e-01, 3.6172e-02,\n            9.9992e-01, 9.7514e-01])</td>
      <td>3.058271884918213</td>
    </tr>
    <tr>
      <th>6</th>
      <td>clear;primary;water</td>
      <td>agriculture;habitation;primary;road;water</td>
      <td>TensorBase([9.9094e-01, 1.3812e-04, 4.5300e-01, 6.2815e-01, 6.4152e-01,\n            7.7717e-01, 8.5307e-01])</td>
      <td>2.4697818756103516</td>
    </tr>
    <tr>
      <th>7</th>
      <td>clear;primary</td>
      <td>agriculture;habitation;primary;road;water</td>
      <td>TensorBase([0.9377, 0.0013, 0.1471, 0.7862, 0.9317, 0.9659, 0.6219])</td>
      <td>2.221360206604004</td>
    </tr>
    <tr>
      <th>8</th>
      <td>clear;primary</td>
      <td>agriculture;road</td>
      <td>TensorBase([6.0217e-01, 3.6376e-04, 3.3483e-02, 3.6663e-01, 4.4091e-01,\n            5.4576e-01, 9.7288e-02])</td>
      <td>1.5774089097976685</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-16-output-6.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="using-the-mid-level-api---version-1" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="using-the-mid-level-api---version-1"><span class="header-section-number">4.2</span> Using the Mid Level API - Version 1</h3>
<p>Using the mid-level api can give us more control over how the dataset is constructed, which will be determined by the task.</p>
<p>The <a href="https://docs.fast.ai/tutorial.datablock.html">Fastai data block tutorial</a> is a great way to understand the methodology behind what the mid level api can do.</p>
<p>So there are many ways we could construct the data using the mid level api, however JH encourages us to consider a list of questions that can be helpful for choosing the best method which are:</p>
<ul>
<li>what are the types of our inputs and targets? Images and multiple labels.</li>
<li>where is the data? In a dataframe.</li>
<li>how do we know if a sample is in the training or the validation set? A column of our dataframe.</li>
<li>how do we get an image? By looking at the column ‘filename’.</li>
<li>how do we know the label of an image? By looking at the column ‘tags’.</li>
<li>do we want to apply a function to a given sample? Yes, we need to resize everything to a given size.</li>
<li>do we want to apply a function to a batch after it’s created? Yes, we want data augmentation.</li>
</ul>
<p>So while our model input (x -images) and outputs (y - labels) are in the dataframe, we need to do need to do a little processing on these dataframe columns before being able to use them, for example the filenames need filepaths added, and the labels need splitting.</p>
<p>We can create a datablock this way to address these needs.</p>
<div class="cell" data-outputid="067639e7-c4b1-4ad5-fa47-ba5c41a945cd" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>planet <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span>ColReader(<span class="st">'filename'</span>, pref<span class="op">=</span><span class="bu">str</span>(path<span class="op">/</span><span class="st">'train'</span>) <span class="op">+</span> os.path.sep),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span>ColReader(<span class="st">'tags'</span>, label_delim<span class="op">=</span><span class="st">' '</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                   item_tfms <span class="op">=</span> Resize(<span class="dv">460</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> planet.dataloaders(df)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We can see we used the <em>get_x &amp; get_y</em> parameters to process the images and labels columns using the <em>ColReader()</em> function. We can also see how the answers to those questions directly translates to different parameters in the DataBlock function.</p>
</section>
<section id="using-the-mid-level-api---version-2" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="using-the-mid-level-api---version-2"><span class="header-section-number">4.3</span> Using the Mid Level API - Version 2</h3>
<p>Another way we could approach this, for getting our images and labels correctly processed is by defining our own functions for doing this using a <em>lambda function</em>.</p>
<div class="cell" data-outputid="cf143791-6590-42ad-acb3-60ce4d9fe18b" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>planet <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span><span class="kw">lambda</span> x:path<span class="op">/</span><span class="st">"train"</span><span class="op">/</span><span class="ss">f'</span><span class="sc">{</span>x[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span><span class="kw">lambda</span> x:x[<span class="dv">1</span>].split(<span class="st">' '</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                   item_tfms <span class="op">=</span> Resize(<span class="dv">460</span>),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> planet.dataloaders(df)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="using-the-mid-level-api---version-3" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="using-the-mid-level-api---version-3"><span class="header-section-number">4.4</span> Using the Mid Level API - Version 3</h3>
<p>Alternatively, for our lambda functions we could use the column names rather than the indexes.</p>
<div class="cell" data-outputid="639fac1a-af05-4f2c-d9ad-6ebddd083f9e" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>planet <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span><span class="kw">lambda</span> o:<span class="ss">f'</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/train/'</span><span class="op">+</span>o.filename,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span><span class="kw">lambda</span> o:o.tags.split(),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                   item_tfms <span class="op">=</span> Resize(<span class="dv">460</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> planet.dataloaders(df)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="using-the-mid-level-api---version-4" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="using-the-mid-level-api---version-4"><span class="header-section-number">4.5</span> Using the Mid Level API - Version 4</h3>
<p>Both of these previous methods would involve iterating over all the rows of the dataframe. For large datasets &amp; dataframes, this could prove very costly in terms of time - not the ideal way for Fastai !</p>
<p>A better and faster way would be to use the <em>from_columns()</em> Datablock method. This uses a user-defined function passed in the <em>get_items</em> parameter to convert the columns into numpy arrays and work with these which would be quicker.</p>
<div class="cell" data-outputid="808dee54-2c83-40e5-8aec-8e1ac592ebd2" data-execution_count="19">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _amazon_items(x): <span class="cf">return</span> (</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f'</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">/train/'</span><span class="op">+</span>x.filename, x.tags.<span class="bu">str</span>.split())</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>planet <span class="op">=</span> DataBlock.from_columns(blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                   get_items<span class="op">=</span>_amazon_items,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                   item_tfms <span class="op">=</span> Resize(<span class="dv">460</span>),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                   batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> planet.dataloaders(df)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-01-15-using-satellite-images-and-deep-learning-to-track-deforestation-in-the-amazon_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="training-our-model-more" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="training-our-model-more"><span class="header-section-number">4.6</span> Training our Model More</h3>
<p>Let’s now train our model for a few more epochs and observe the progress.</p>
<div class="cell" data-outputid="05a48846-d149-43b5-c1a0-e43e98284a50" data-execution_count="20">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">12</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>F1(macro)</th>
      <th>F1(samples)</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.839966</td>
      <td>1.319353</td>
      <td>0.628571</td>
      <td>0.423056</td>
      <td>0.526470</td>
      <td>00:02</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy_multi</th>
      <th>F1(macro)</th>
      <th>F1(samples)</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.816123</td>
      <td>0.863024</td>
      <td>0.662857</td>
      <td>0.434543</td>
      <td>0.519232</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.743988</td>
      <td>0.717785</td>
      <td>0.714286</td>
      <td>0.561080</td>
      <td>0.625896</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.748999</td>
      <td>0.740482</td>
      <td>0.645714</td>
      <td>0.488145</td>
      <td>0.593423</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.726016</td>
      <td>0.943211</td>
      <td>0.605714</td>
      <td>0.451780</td>
      <td>0.529645</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.710094</td>
      <td>1.014733</td>
      <td>0.622857</td>
      <td>0.514764</td>
      <td>0.472312</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>5</td>
      <td>0.707066</td>
      <td>0.860917</td>
      <td>0.697143</td>
      <td>0.643097</td>
      <td>0.563126</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>6</td>
      <td>0.692620</td>
      <td>0.711039</td>
      <td>0.702857</td>
      <td>0.556803</td>
      <td>0.558268</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.679113</td>
      <td>0.690488</td>
      <td>0.691429</td>
      <td>0.542517</td>
      <td>0.570459</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.668592</td>
      <td>0.613841</td>
      <td>0.720000</td>
      <td>0.580288</td>
      <td>0.608078</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>9</td>
      <td>0.664969</td>
      <td>0.561042</td>
      <td>0.748571</td>
      <td>0.617624</td>
      <td>0.648078</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>10</td>
      <td>0.652281</td>
      <td>0.525281</td>
      <td>0.760000</td>
      <td>0.630952</td>
      <td>0.665602</td>
      <td>00:04</td>
    </tr>
    <tr>
      <td>11</td>
      <td>0.635785</td>
      <td>0.508053</td>
      <td>0.754286</td>
      <td>0.626052</td>
      <td>0.635316</td>
      <td>00:04</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">5</span> Conclusion</h2>
<p>In this article we used the Amazon images dataset to illustrate the different ways we can use the Fastai library to prepare the data for the task. We used both the high &amp; mid level api, and in particular explored the many options the mid level api offers to make it easy and fast to prepare data for deep learning model training.</p>


</section>

<link href="//cdn-images.mailchimp.com/embedcode/classic-071822.css" rel="stylesheet" type="text/css"><div id="mc_embed_signup">
    <form action="https://livingdatalab.us8.list-manage.com/subscribe/post?u=e2d57b0d6e43b4f6bff927a55&amp;id=a30bdff125&amp;f_id=009d05e0f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
        <div id="mc_embed_signup_scroll">
        <h2 class="anchored">Subscribe</h2>
<div class="mc-field-group">
    <label for="mce-EMAIL">Email Address
</label>
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required="">
    <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
    <div id="mce-responses" class="clear foot">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_e2d57b0d6e43b4f6bff927a55_a30bdff125" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
            </div>
        </div>
    </div>
</form>
</div><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/http:\/\/livingdatalab\.com/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">LivingDataLab Data Science Blog</div>
  </div>
</footer>



</body></html>